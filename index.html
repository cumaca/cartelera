<script>
        // === IMPORTANTE: ASEGÚRATE DE QUE ESTA SEA TU URL DE LA "NUEVA IMPLEMENTACIÓN" ===
        const API_URL = "https://script.google.com/macros/s/AKfycbxWQCoBctEYLdVGexgwcu4z_mXzym78f1EZnTQi4HkjzSil18chRBM-qgt7xhQEqaOX/exec"; 

        let db = { grupos: [], vida: [], finde: [], anuncios: [] };
        let selectedDate = new Date();
        const today = new Date();

        function toISO(d) { return d.toISOString().split('T')[0]; }
        function sameDay(d1, d2) { return toISO(d1) === toISO(d2); }

        async function init() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error("Error de conexión con Google Sheets");
                const data = await res.json();
                
                // Asignamos datos protegiéndonos de nombres de pestañas incorrectos
                db.grupos = data.grupos || [];
                db.vida = data.vidaMinisterio || []; 
                db.finde = data.finSemana || [];
                db.anuncios = data.anuncios || [];

                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('last-update').innerText = new Date().toLocaleTimeString();
                
                renderCarousel();
                renderGrupos();
                renderReuniones();
                renderAnuncios();
            } catch (e) {
                document.getElementById('loading-overlay').innerHTML = `<p style="color:red; text-align:center; padding:20px;">Error: ${e.message}<br><br>Verifica que publicaste el script como "Nueva Implementación".</p>`;
                console.error(e);
            }
        }

        // === CORRECCIÓN CLAVE: LÓGICA DE GRUPOS HÍBRIDA ===
        function renderGrupos() {
            const container = document.getElementById('grupos-dia-content');
            const dateStr = toISO(selectedDate);
            
            // 1. INTENTO "EXCEL FÁCIL" (Múltiples filas con la misma fecha)
            // Busca todas las filas que coincidan con la fecha seleccionada
            const flatGroups = db.grupos.filter(g => g.fecha === dateStr || g.Fecha === dateStr); // Soporta mayúscula/minúscula

            if (flatGroups.length > 0) {
                // Si encontramos filas individuales, las renderizamos directamente
                // Verificamos si tienen la columna 'hora' o 'Hora'
                if (flatGroups[0].hora || flatGroups[0].Hora) {
                    container.innerHTML = flatGroups.map(g => `
                        <div class="grupo-hoy-card">
                            <div class="grupo-row">
                                <div class="grupo-time">${g.hora || g.Hora}</div>
                                <div class="grupo-details">
                                    <div class="grupo-terr">${g.territorio || g.Territorio}</div>
                                    <div class="grupo-cond">Cond: ${g.conductor || g.Conductor}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    return;
                }
            }

            // 2. INTENTO "FORMATO ANTIGUO/JSON" (Una fila con columna 'grupos')
            const data = db.grupos.find(g => g.fecha === dateStr);
            if(!data || (!data.grupos && !data.Grupos)) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#999; font-style:italic;">No hay grupos hoy.</div>';
                return;
            }

            let gruposArr = [];
            try {
                const raw = data.grupos || data.Grupos;
                gruposArr = (typeof raw === 'string') ? JSON.parse(raw) : raw;
            } catch(e) {
                console.log("Error parseando grupos JSON");
                container.innerHTML = "Error en formato de datos de grupos"; return;
            }

            container.innerHTML = gruposArr.map(g => `
                <div class="grupo-hoy-card">
                    <div class="grupo-row">
                        <div class="grupo-time">${g.hora}</div>
                        <div class="grupo-details">
                            <div class="grupo-terr">${g.territorio}</div>
                            <div class="grupo-cond">Cond: ${g.conductor}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderReuniones() {
            const day = selectedDate.getDay();
            const diff = selectedDate.getDate() - day + (day == 0 ? -6 : 1); 
            const monday = new Date(selectedDate); monday.setDate(diff);
            const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);

            const monStr = toISO(monday);
            const sunStr = toISO(sunday);

            // Filtro robusto para fechas
            const vidaData = db.vida.find(r => (r.fecha === monStr) || (r.fecha >= monStr && r.fecha <= sunStr));
            const findeData = db.finde.find(r => (r.fecha === sunStr) || (r.fecha >= monStr && r.fecha <= sunStr));

            const vContainer = document.getElementById('vida-content');
            const vFecha = document.getElementById('vida-fecha');
            const vBasico = document.getElementById('vida-basico');
            
            if (vidaData) {
                vFecha.textContent = formatDate(vidaData.fecha);
                vBasico.innerHTML = `Presidente: <strong>${vidaData.presidente}</strong> • Oración: ${vidaData.oracionInicial}`;
                
                let html = `
                <div class="section-tesoros">
                    <h4>Tesoros de la Biblia</h4>
                    <div class="part-item"><div class="part-title">Canción ${vidaData.tesoros_cancion}</div></div>
                    <div class="part-item">
                        <span class="part-title">Introducción</span><span class="part-time">(${vidaData.tesoros_introduccion_tiempo})</span>
                        <div class="part-assignee">${vidaData.tesoros_introduccion_hermano}</div>
                    </div>
                    <div class="part-item">
                        <span class="part-title">${vidaData.tesoros_parte1_titulo}</span><span class="part-time">(${vidaData.tesoros_parte1_tiempo})</span>
                        <div class="part-assignee">${vidaData.tesoros_parte1_principal}</div>
                        ${renderSecondRoom(vidaData.tesoros_parte1_segundaSala)}
                    </div>
                    <div class="part-item">
                        <span class="part-title">${vidaData.tesoros_parte2_titulo}</span><span class="part-time">(${vidaData.tesoros_parte2_tiempo})</span>
                        <div class="part-assignee">${vidaData.tesoros_parte2_principal}</div>
                        ${renderSecondRoom(vidaData.tesoros_parte2_segundaSala)}
                    </div>
                    <div class="part-item">
                        <span class="part-title">Lectura: ${vidaData.tesoros_lectura_textos}</span><span class="part-time">(${vidaData.tesoros_lectura_tiempo})</span>
                        <div class="part-assignee">Estudiante: <strong>${vidaData.tesoros_lectura_estudiante}</strong></div>
                        ${renderSecondRoom(vidaData.tesoros_lectura_segundaSala)}
                    </div>
                </div>
                
                <div class="section-maestros"><h4>Seamos Mejores Maestros</h4>`;
                
                if(vidaData.maestros_salaAuxiliar) {
                   html += `<div style="font-size:12px; margin-bottom:10px; color:#666; font-style:italic;">Sala Auxiliar: ${vidaData.maestros_salaAuxiliar}</div>`;
                }

                for(let i=1; i<=5; i++) {
                    const titulo = vidaData[`maestros_parte${i}_titulo`];
                    if(titulo) {
                        html += `
                        <div class="part-item">
                            <span class="part-title">${titulo}</span><span class="part-time">(${vidaData[`maestros_parte${i}_tiempo`]})</span>
                            <div class="part-assignee">${formatHelper(vidaData[`maestros_parte${i}_principal`], vidaData[`maestros_parte${i}_ayudante`])}</div>
                            ${renderSecondRoom(vidaData[`maestros_parte${i}_segundaSala_principal`], vidaData[`maestros_parte${i}_segundaSala_ayudante`])}
                        </div>`;
                    }
                }
                html += `</div>
                
                <div class="section-vida">
                    <h4>Nuestra Vida Cristiana</h4>
                    <div class="part-item"><div class="part-title">Canción ${vidaData.vida_cancion1}</div></div>
                    <div class="part-item">
                        <span class="part-title">${vidaData.vida_parte1_titulo}</span><span class="part-time">(${vidaData.vida_parte1_tiempo})</span>
                        <div class="part-assignee">${vidaData.vida_parte1_hermano}</div>
                    </div>
                    <div class="part-item">
                        <span class="part-title">Estudio bíblico</span><span class="part-time">(${vidaData.vida_estudioBiblico_tiempo})</span>
                        <div class="part-assignee">${vidaData.vida_estudioBiblico_conductor} / Lector: ${vidaData.vida_estudioBiblico_lector}</div>
                    </div>
                    <div class="part-item">
                         <span class="part-title">Conclusión</span><span class="part-time">(${vidaData.vida_conclusion_tiempo})</span>
                         <div class="part-assignee">${vidaData.vida_conclusion_hermano} • Oración: ${vidaData.oracionFinal}</div>
                    </div>
                    <div class="part-item"><div class="part-title">Canción ${vidaData.vida_cancion2}</div></div>
                </div>`;

                html += renderAssignmentsTable(vidaData, 'entreSemana');
                vContainer.innerHTML = html;
            } else {
                vContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">No hay programación.</div>';
                vFecha.textContent = ""; vBasico.innerHTML = "";
            }

            const fContainer = document.getElementById('finde-content');
            const fFecha = document.getElementById('finde-fecha');
            const fBasico = document.getElementById('finde-basico');

            if (findeData) {
                fFecha.textContent = formatDate(findeData.fecha);
                fBasico.innerHTML = `Presidente: <strong>${findeData.presidente}</strong>`;

                let html = `
                <div class="section-tesoros" style="background:white; border:1px solid #eee; margin-bottom:15px;">
                    <div class="part-item" style="border:none;">
                        <span class="part-title">Discurso Público</span>
                        <div style="font-size:16px; font-weight:700; color:#212121; margin-top:4px;">"${findeData.discursoPublico_tema}"</div>
                        <div class="part-assignee" style="margin-top:4px;">${findeData.discursoPublico_orador} <span style="font-size:12px; color:#666;">(${findeData.discursoPublico_congregacion})</span></div>
                    </div>
                </div>
                <div class="section-tesoros" style="background:white; border:1px solid #eee;">
                    <div class="part-item" style="border:none;">
                        <span class="part-title">Estudio de La Atalaya</span>
                        <div style="font-size:15px; font-weight:600; margin-top:4px;">${findeData.estudioAtalaya_articulo}</div>
                        <div class="part-assignee" style="margin-top:4px;">
                            Conductor: ${findeData.estudioAtalaya_conductor}<br>
                            Lector: ${findeData.estudioAtalaya_lector}
                        </div>
                    </div>
                </div>
                <div style="margin-top:15px; font-size:13px; padding-left:4px;">Oración Final: <strong>${findeData.oracionFinal}</strong></div>`;
                
                html += renderAssignmentsTable(findeData, 'finSemana');
                fContainer.innerHTML = html;
            } else {
                fContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">No hay programación.</div>';
                fFecha.textContent = ""; fBasico.innerHTML = "";
            }
        }

        function renderSecondRoom(principal, ayudante) {
            if (!principal) return '';
            let text = principal;
            if (ayudante) text += ` / ${ayudante} (Ayudante)`;
            return `<div class="second-room"><span class="second-room-label">Segunda Sala:</span> ${text}</div>`;
        }

        function formatHelper(principal, ayudante) {
            if (!ayudante) return principal;
            return `${principal} / ${ayudante} (Ayudante)`;
        }

        function renderAssignmentsTable(data, type) {
            if (!data) return '';
            let items = '';
            
            // Lógica de limpieza y hospitalidad (Solo números de grupos)
            if (type === 'entreSemana' && data.limpiezaSuperficial) items += rowAsig('Limpieza Superficial', 'Grupo ' + data.limpiezaSuperficial);
            if (type === 'finSemana' && data.limpiezaAFondo) items += rowAsig('Limpieza a Fondo', 'Grupo ' + data.limpiezaAFondo);
            if (type === 'finSemana' && data.hospitalidad) items += rowAsig('Hospitalidad', 'Grupo ' + data.hospitalidad);
            
            // Asignaciones comunes
            if(data.acomodadorAuditorio1) items += rowAsig('Acomodadores', `${data.acomodadorAuditorio1} ${data.acomodadorAuditorio2 ? '| '+data.acomodadorAuditorio2 : ''}`);
            if(data.acomodadorPuerta) items += rowAsig('Puerta', data.acomodadorPuerta);
            if(data.microfonos1) items += rowAsig('Micrófonos', `${data.microfonos1} ${data.microfonos2 ? '| '+data.microfonos2 : ''}`);
            if(data.audioVideo1) items += rowAsig('Audio/Video', `${data.audioVideo1} ${data.audioVideo2 ? '| '+data.audioVideo2 : ''}`);
            if(data.plataforma) items += rowAsig('Plataforma', data.plataforma);

            if(items === '') return '';

            return `
            <div class="assignments-container">
                <div class="assignments-title">Asignaciones y Responsabilidades</div>
                <div class="assignments-grid">
                    ${items}
                </div>
            </div>`;
        }

        function rowAsig(label, value) {
            if(!value) return '';
            return `<div class="assign-row"><span class="assign-label">${label}</span><span class="assign-value">${value}</span></div>`;
        }

        function renderAnuncios() {
            const container = document.getElementById('anuncios-content');
            const now = toISO(new Date());
            const validos = db.anuncios.filter(a => a.fechaInicio <= now && a.fechaFin >= now);
            if(validos.length === 0) { container.innerHTML = '<div style="text-align:center; color:#999;">No hay anuncios.</div>'; return; }
            container.innerHTML = validos.map(a => `<div class="anuncio"><div class="anuncio-date">Vigente hasta: ${formatDateShort(a.fechaFin)}</div><div>${a.texto}</div></div>`).join('');
        }

        function renderCarousel() {
            const c = document.getElementById('carousel'); c.innerHTML = '';
            for(let i=-5; i<=15; i++) {
                let d = new Date(today); d.setDate(today.getDate() + i);
                let el = document.createElement('div');
                el.className = `date-card ${sameDay(d, selectedDate) ? 'selected' : ''} ${sameDay(d, today) ? 'is-today' : ''}`;
                el.innerHTML = `<div class="date-card-day">${d.toLocaleDateString('es-ES',{weekday:'short'}).slice(0,3)}</div><div class="date-card-number">${d.getDate()}</div>`;
                el.onclick = () => { selectedDate = d; renderCarousel(); renderGrupos(); renderReuniones(); document.getElementById('month-indicator').innerText = d.toLocaleDateString('es-ES', {month:'long'}); };
                c.appendChild(el);
            }
            document.getElementById('month-indicator').innerText = selectedDate.toLocaleDateString('es-ES', {month:'long'});
        }

        function goToToday() { selectedDate = new Date(); renderCarousel(); renderGrupos(); renderReuniones(); }
        function formatDate(isoStr) { if(!isoStr) return ''; const parts = isoStr.split('-'); const d = new Date(parts[0], parts[1]-1, parts[2]); return d.toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'long'}); }
        function formatDateShort(isoStr) { const parts = isoStr.split('-'); return `${parts[2]}/${parts[1]}`; }

        init();
    </script>
