<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cartelera Digital - La Cumaca</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { font-family: 'Inter', sans-serif; background: #ffffff; min-height: 100vh; padding: 16px; color: #4b5563; }
        .container { max-width: 480px; margin: 0 auto; padding-bottom: 60px; }
        
        /* TARJETAS */
        .card { 
            background: #ffffff; 
            border: none; 
            border-radius: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); 
            margin-bottom: 48px; 
            overflow: hidden; 
            position: relative; 
        }
        
        /* HEADER */
        .header { text-align: center; padding: 24px 16px 20px; }
        .header h1 { 
            font-family: 'Inter', sans-serif; 
            font-size: 20px; 
            font-weight: 700; 
            color: #9ca3af; 
            text-transform: capitalize; 
            letter-spacing: -0.5px;
        }
        
        /* NAV MENU SEGMENTADO */
        .nav-segment-container { display: flex; justify-content: center; align-items: center; margin-bottom: 32px; }
        .nav-segment { 
            display: inline-flex; align-items: center; 
            background: #f3f4f6; border-radius: 12px; padding: 4px; 
        }
        .nav-btn { 
            text-decoration: none; 
            display: flex; align-items: center; gap: 6px;
            padding: 8px 16px; 
            color: #6b7280; font-size: 13px; font-weight: 600; 
            transition: all 0.2s; border-radius: 8px;
        }
        .nav-btn:hover { color: #1f2937; background: rgba(255,255,255,0.5); }
        .nav-btn svg { width: 16px; height: 16px; stroke-width: 2; }
        .nav-divider { width: 1px; height: 14px; background: #d1d5db; margin: 0 2px; }

        /* TÍTULOS DE SECCIÓN */
        .section-title-main { 
            font-family: 'Inter', sans-serif; font-size: 22px; font-weight: 800; color: #374151; 
            margin: 24px 20px 8px 20px; text-align: left; letter-spacing: -0.5px;
        }
        
        /* INDICADOR DE MES (GRIS) */
        .month-indicator {
            margin-left: 20px; margin-bottom: 24px; 
            font-size: 13px; font-weight: 800; 
            color: #6b7280; 
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* CARRUSEL */
        .carousel-wrapper { position: relative; padding: 0 10px 20px 10px; }
        .carousel-arrow { 
            position: absolute; top: 50%; transform: translateY(-50%); 
            width: 28px; height: 28px; background: white; 
            border-radius: 50%; border: 1px solid #e5e7eb; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            z-index: 10; box-shadow: 0 2px 6px rgba(0,0,0,0.05); color: #6b7280;
        }
        .carousel-arrow:hover { color: #16a34a; border-color: #16a34a; }
        .carousel-arrow-left { left: 4px; } .carousel-arrow-right { right: 4px; }
        @media (hover: none) and (pointer: coarse) { .carousel-arrow { display: none !important; } }

        .btn-today-floating {
            position: absolute; top: -12px; right: 20px;
            background: white; border: 1px solid #16a34a; color: #16a34a;
            font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 20px;
            cursor: pointer; display: none; align-items: center; gap: 4px; 
            box-shadow: 0 2px 8px rgba(22, 163, 74, 0.15); animation: fadeIn 0.3s ease; z-index: 20;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .carousel { 
            padding: 20px 24px 4px 24px; 
            display: flex; gap: 10px; 
            overflow-x: auto; scroll-snap-type: x mandatory; 
            -webkit-overflow-scrolling: touch; scrollbar-width: none; 
        }
        .carousel::-webkit-scrollbar { display: none; }

        /* AJUSTE COLOR GRIS MEDIO PARA FECHAS NO SELECCIONADAS */
        .date-card { scroll-snap-align: center; min-width: 60px; padding: 10px 6px; border-radius: 14px; text-align: center; cursor: pointer; transition: all 0.3s ease; flex-shrink: 0; background: #f9fafb; border: 1px solid transparent; color: #6b7280; }
        .date-card.is-today { border: 2px solid #16a34a; background: #ffffff; color: #6b7280; }
        .date-card.selected { background: #16a34a; color: white; box-shadow: 0 4px 10px rgba(22, 163, 74, 0.25); transform: translateY(-2px); border-color: #16a34a; }
        .date-card-day { font-size: 10px; font-weight: 600; text-transform: uppercase; margin-bottom: 2px; opacity: 0.8; }
        .date-card-number { font-size: 20px; font-weight: 800; line-height: 1; }

        /* CALENDARIO */
        .calendar-toggle-wrapper { display: flex; justify-content: flex-end; padding-right: 20px; margin-top: -10px; margin-bottom: 10px; }
        .calendar-toggle { display: flex; align-items: center; gap: 4px; color: #16a34a; font-size: 12px; font-weight: 700; cursor: pointer; border: none; background: none; padding: 6px 10px; border-radius: 8px; transition: background 0.2s; }
        .calendar-toggle:hover { background: #f0fdf4; }
        .section-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .section-content.expanded { max-height: 5000px; }
        .section-inner { padding: 0 20px 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px; }
        .calendar-nav-btn { cursor: pointer; padding: 8px 12px; color: #4b5563; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .calendar-month { font-size: 14px; font-weight: 700; color: #374151; text-transform: capitalize; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
        .calendar-day-header { text-align: center; font-size: 11px; font-weight: 700; color: #374151; padding: 4px 0; }
        .calendar-day { text-align: center; padding: 8px 4px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; color: #374151; background: #f9fafb; }
        .calendar-day.selected { background: #16a34a !important; color: white !important; font-weight: 700; }
        .calendar-day.today { border: 1px solid #16a34a; color: #16a34a; font-weight: 700; }

        /* GRUPOS HOY */
        .grupos-dia-container { padding: 0 20px 20px; }
        .grupo-consolidado-card { background: #f9fafb; border-radius: 16px; padding: 16px; border: 1px solid #f3f4f6; }
        /* TÍTULO GRUPOS DEL DÍA EN GRIS MEDIO */
        .grupo-consolidado-header { font-size: 13px; font-weight: 800; color: #6b7280; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .grupo-consolidado-header svg { color: #9ca3af; }
        .grupo-item-hoy { padding-bottom: 16px; border-bottom: 1px solid #e5e7eb; margin-bottom: 16px; }
        .grupo-item-hoy:last-child { padding-bottom: 0; border-bottom: none; margin-bottom: 0; }
        .gh-hora-hoy { font-size: 13px; font-weight: 800; color: #6b7280; background: #ffffff; border: 1px solid #d1d5db; padding: 6px 0; border-radius: 8px; white-space: nowrap; flex-shrink: 0; width: 70px; text-align: center; line-height: 1.3; }
        .grupo-row-flex { display: flex; gap: 14px; align-items: flex-start; }
        .grupo-content-col { flex-grow: 1; }
        .gh-top-row { display: flex; flex-wrap: wrap; align-items: baseline; gap: 8px; }
        .gh-territorio { font-size: 15px; font-weight: 700; color: #374151; line-height: 1.2; margin-top: 3px; }
        .gh-conductor { font-size: 13px; color: #6b7280; font-weight: 500; }
        .gh-asignados { font-size: 13px; color: #6b7280; font-weight: 600; margin-top: 4px; }

        /* TIMELINE */
        .timeline-wrapper { padding-top: 10px; margin-left: 10px; } 
        .timeline-day-block { position: relative; padding-left: 28px; border-left: 2px solid #e5e7eb; padding-bottom: 30px; transition: all 0.3s; }
        .timeline-day-block:last-child { border-left: 2px solid transparent; border-image: linear-gradient(to bottom, #e5e7eb 0%, transparent 100%) 1 100%; }
        .timeline-date-header { position: relative; font-size: 15px; font-weight: 800; color: #9ca3af; margin-bottom: 16px; text-transform: capitalize; line-height: 1; top: -5px; transition: color 0.3s; }
        .timeline-date-header::before { content: ''; position: absolute; left: -35px; top: 1px; width: 12px; height: 12px; background: #9ca3af; border-radius: 50%; box-shadow: 0 0 0 4px rgba(156, 163, 175, 0.15); z-index: 1; transition: all 0.3s; }
        .timeline-day-block.active-day .timeline-date-header { color: #16a34a; }
        .timeline-day-block.active-day .timeline-date-header::before { background: #16a34a; box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.2); }
        .timeline-day-block.active-day .gh-hora-timeline { color: #16a34a; border-color: #16a34a; background: #f0fdf4; }
        .timeline-row { position: relative; padding-bottom: 24px; }
        .gh-hora-timeline { font-size: 13px; font-weight: 700; color: #9ca3af; background: #f9fafb; border: 1px solid #e5e7eb; padding: 6px 0; border-radius: 8px; white-space: nowrap; flex-shrink: 0; width: 70px; text-align: center; transition: all 0.3s; }

        /* REUNIONES */
        .reunion-week-nav { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 24px; padding: 12px; }
        .week-nav-arrow { width: 36px; height: 36px; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #16a34a; }
        .week-nav-arrow svg { stroke: #16a34a; }
        .week-nav-text { font-size: 15px; font-weight: 800; color: #16a34a; text-transform: capitalize; cursor: pointer; white-space: nowrap; }
        .reunion-card { border-radius: 16px; padding: 20px; border: 1px solid #f3f4f6; cursor: pointer; margin-bottom: 20px; background: #fdfdfd; transition: all 0.2s; }
        .reunion-card.active-card { border-color: #16a34a; background: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        /* TÍTULO REUNIÓN EN GRIS MEDIO */
        .reunion-info h3 { font-weight: 800; color: #6b7280; margin-bottom: 6px; font-size: 16px; }
        .reunion-badge { display: inline-block; background: #16a34a; color: white; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 6px; margin-left: 6px; text-transform: uppercase; vertical-align: middle; }
        .reunion-date { font-size: 13px; color: #6b7280; margin-bottom: 4px; font-weight: 500; }
        .reunion-time { font-size: 13px; font-weight: 700; color: #16a34a; }
        .reunion-timeline-item { position: relative; padding-left: 24px; padding-bottom: 20px; }
        .reunion-timeline-dot { position: absolute; left: 0; top: 7px; width: 14px; height: 14px; border-radius: 50%; background: white; border: 3px solid #e5e7eb; z-index: 1; }
        
        /* TÍTULOS DE PARTES EN GRIS MEDIO */
        .reunion-item-content { font-size: 14px; color: #374151; line-height: 1.5; }
        .reunion-item-content strong { color: #6b7280; font-weight: 700; }
        .reunion-item-auxiliar { display: block; margin-top: 2px; font-size: 14px; color: #374151; padding-left: 16px; border-left: 2px solid #e5e7eb; }
        
        .asignaciones-box { background: #f3f4f6; border-radius: 16px; padding: 16px; margin-top: 16px; }
        .asignaciones-header { font-size: 12px; font-weight: 800; color: #1f2937; text-transform: uppercase; margin-bottom: 12px; }
        .asignaciones-table { width: 100%; border-collapse: collapse; }
        .asignaciones-table tr { border-bottom: 1px solid #e5e7eb; }
        .asignaciones-table td { padding: 8px 0; font-size: 13px; color: #4b5563; }
        .asignaciones-table td:first-child { font-weight: 600; color: #6b7280; width: 40%; }

        /* ANUNCIOS */
        .anuncio { background: #fffbeb; border-radius: 16px; padding: 16px; margin-bottom: 16px; display: flex; gap: 14px; align-items: flex-start; }
        .anuncio-date { background: #d97706; color: white; font-size: 11px; font-weight: 800; padding: 4px 8px; border-radius: 6px; white-space: nowrap; margin-top: 2px; }
        .anuncio-text { font-size: 14px; color: #4b5563; flex: 1; line-height: 1.5; }
        .footer { text-align: center; color: #d1d5db; font-size: 11px; margin-top: 40px; }
        .hidden { display: none !important; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.4s ease; }
        .spinner { width: 30px; height: 30px; border: 3px solid #f3f4f6; border-top: 3px solid #1f2937; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" style="color:#9ca3af; font-weight: 600; font-size: 13px;">Cargando...</p>
    </div>

    <div class="container">
        <div class="header"><h1>Cartelera Cong. La Cumaca</h1></div>
        
        <div class="nav-segment-container">
            <div class="nav-segment">
                <a href="#grupos-section" class="nav-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg> Grupos
                </a>
                <div class="nav-divider"></div>
                <a href="#reuniones-section" class="nav-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg> Reuniones
                </a>
                <div class="nav-divider"></div>
                <a href="#anuncios-section" class="nav-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" /></svg> Anuncios
                </a>
            </div>
        </div>

        <div class="card" id="grupos-section">
            <h2 class="section-title-main">Grupos de Predicación</h2>
            <div id="month-indicator" class="month-indicator"></div>
            <div class="carousel-wrapper">
                <button id="btn-today" class="btn-today-floating" onclick="goToToday()">Ir a Hoy</button>
                <div class="carousel-arrow carousel-arrow-left" onclick="scrollCarousel(-1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></div>
                <div class="carousel-arrow carousel-arrow-right" onclick="scrollCarousel(1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></div>
                <div class="carousel" id="carousel"></div>
            </div>
            <div class="calendar-toggle-wrapper"><button class="calendar-toggle" onclick="toggleSection('calendario')"><span id="calendar-toggle-text">Mostrar calendario</span></button></div>
            <div class="section-content" id="calendario-content">
                <div class="section-inner"><div class="calendar-header"><div class="calendar-nav-btn" onclick="navMes(-1)">❮</div><div class="calendar-month" id="calendar-month"></div><div class="calendar-nav-btn" onclick="navMes(1)">❯</div></div><div class="calendar-grid" id="calendario-grid"></div></div>
            </div>
            <div id="swipe-grupos-hoy" class="grupos-dia-container"><div id="grupos-dia-content"></div></div>
            <div style="padding: 0 20px 20px;"><button class="ver-todos-btn" id="ver-todos-btn" onclick="toggleSection('todos-grupos')"><span id="ver-todos-text">Ver todos los grupos</span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;color:#16a34a;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></button></div>
            <div class="section-content" id="todos-grupos-content"><div class="section-inner"><div id="swipe-timeline" class="timeline-wrapper"></div><div id="paginacion-container" class="pagination-container hidden"></div></div></div>
        </div>

        <h2 class="section-title-main" id="reuniones-section">Programa de Reuniones</h2>
        <div class="card" id="card-programa-reuniones" style="padding: 20px;">
            <div class="reunion-week-nav">
                <div class="week-nav-arrow" onclick="cambiarSemana(-1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 19l-7-7 7-7" /></svg></div>
                <div class="week-nav-text" onclick="resetearSemana()">Esta Semana</div>
                <div class="week-nav-arrow" onclick="cambiarSemana(1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 5l7 7-7 7" /></svg></div>
            </div>
            <div class="reunion-card" onclick="toggleSection('reunion-semana')">
                <div class="reunion-header"><div class="reunion-info"><h3>Reunión Entre Semana <span class="reunion-badge hidden" id="badge-semana">HOY</span></h3><p class="reunion-date" id="fecha-semana"></p><p class="reunion-time">Jueves 6:30 PM</p></div><svg class="section-arrow" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" /></svg></div>
            </div>
            <div class="section-content" id="reunion-semana-content"><div class="section-inner" id="reunion-semana-detalle"></div></div>
            <div class="reunion-card" onclick="toggleSection('reunion-finde')">
                <div class="reunion-header"><div class="reunion-info"><h3>Reunión Fin de Semana <span class="reunion-badge hidden" id="badge-finde">HOY</span></h3><p class="reunion-date" id="fecha-finde"></p><p class="reunion-time">Domingo 10:00 AM</p></div><svg class="section-arrow" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" /></svg></div>
            </div>
            <div class="section-content" id="reunion-finde-content"><div class="section-inner" id="reunion-finde-detalle"></div></div>
        </div>

        <h2 class="section-title-main" id="anuncios-section">Anuncios</h2>
        <div class="card" style="padding: 20px;"><div id="anuncios-lista"></div></div>
        <div class="footer"><p>Actualización automática • Conectado</p><p id="data-stats"></p></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxWQCoBctEYLdVGexgwcu4z_mXzym78f1EZnTQi4HkjzSil18chRBM-qgt7xhQEqaOX/exec"; 
        let dbGrupos = [], dbVidaMinisterio = [], dbFinSemana = [], dbAnuncios = [];
        let fechaHoy = new Date();
        let fechaSeleccionada = new Date(fechaHoy);
        let fechaVisualizadaCalendario = new Date(fechaHoy);
        let semanaOffset = 0;
        let paginaGruposActual = 1;
        const diasPorPagina = 3; 

        function toISODate(d) { return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }

        async function iniciarApp() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                dbGrupos = data.grupos || [];
                dbVidaMinisterio = data.vidaMinisterio || [];
                dbFinSemana = data.finSemana || [];
                dbAnuncios = data.anuncios || [];
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('data-stats').textContent = `Registros: ${dbGrupos.length + dbVidaMinisterio.length + dbFinSemana.length}`;
                renderAll();
                setupSwipeGestures();
                setupMonthScrollListener();
                setTimeout(() => goToToday(), 500);
            } catch (error) { console.error(error); }
        }

        function setupMonthScrollListener() {
            const carousel = document.getElementById('carousel');
            const indicator = document.getElementById('month-indicator');
            carousel.addEventListener('scroll', () => {
                const cards = document.querySelectorAll('.date-card');
                const carouselRect = carousel.getBoundingClientRect();
                for (let card of cards) {
                    const cardRect = card.getBoundingClientRect();
                    if (cardRect.left >= carouselRect.left - 20 && cardRect.right <= carouselRect.right + 100) {
                        if(card.dataset.date) {
                            const d = new Date(card.dataset.date + "T12:00:00");
                            indicator.textContent = d.toLocaleDateString('es-ES', {month:'long', year:'numeric'});
                        }
                        break;
                    }
                }
            });
        }

        function setupSwipeGestures() {
            setupSwipe('swipe-grupos-hoy', () => cambiarDiaSeleccionado(1), () => cambiarDiaSeleccionado(-1));
            setupSwipe('card-programa-reuniones', () => cambiarSemana(1), () => cambiarSemana(-1));
            setupSwipe('swipe-timeline', () => {
                const hoyStr = toISODate(fechaHoy);
                let listaFechas = dbGrupos.filter(g => g.fecha >= hoyStr);
                if(paginaGruposActual < Math.ceil(listaFechas.length/diasPorPagina)) { paginaGruposActual++; renderTodosGruposPaginados(); }
            }, () => { if(paginaGruposActual > 1) { paginaGruposActual--; renderTodosGruposPaginados(); } });
        }

        function setupSwipe(id, onLeft, onRight) {
            const el = document.getElementById(id); if(!el) return;
            let startX = 0;
            el.addEventListener('touchstart', e => { startX = e.changedTouches[0].screenX; }, {passive: true});
            el.addEventListener('touchend', e => {
                const diffX = startX - e.changedTouches[0].screenX;
                if (Math.abs(diffX) > 50) { if (diffX > 0) onLeft(); else onRight(); }
            }, {passive: true});
        }

        function cambiarDiaSeleccionado(d) { fechaSeleccionada.setDate(fechaSeleccionada.getDate() + d); renderAll(); centrarSeleccion(); }
        function centrarSeleccion() { const s = document.querySelector('.date-card.selected'); if(s) s.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' }); }

        function goToToday() { fechaSeleccionada = new Date(fechaHoy); semanaOffset = 0; renderAll(); centrarSeleccion(); }

        function renderGruposDia() {
            const container = document.getElementById('grupos-dia-content');
            const data = dbGrupos.find(g => g.fecha === toISODate(fechaSeleccionada));
            if (!data || !data.grupos || data.grupos.length === 0) {
                container.innerHTML = `<div class="no-grupos">No hay grupos programados para este día.</div>`;
                return;
            }
            let html = '';
            data.grupos.forEach(g => {
                html += `<div class="grupo-item-hoy"><div class="grupo-row-flex"><div class="gh-hora-hoy">${g.hora}</div><div class="grupo-content-col"><div class="gh-top-row"><div class="gh-territorio">${g.territorio}</div><div class="gh-conductor">${g.conductor}</div></div>${g.gruposAssigned ? `<div class="gh-asignados">${g.gruposAssigned}</div>` : ''}</div></div></div>`;
            });
            container.innerHTML = `<div class="grupo-consolidado-card"><div class="grupo-consolidado-header"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>Grupos del ${fechaSeleccionada.toLocaleDateString('es-ES', { weekday: 'long' })}</div>${html}</div>`;
        }

        function renderReuniones() {
            const d = new Date(fechaHoy);
            const diff = d.getDate() - d.getDay() + (d.getDay() == 0 ? -6 : 1) + (semanaOffset * 7);
            const lunes = new Date(d.setDate(diff));
            const domingo = new Date(lunes); domingo.setDate(lunes.getDate() + 6);
            const rango = `${lunes.getDate()} ${lunes.toLocaleDateString('es-ES',{month:'short'})} - ${domingo.getDate()} ${domingo.toLocaleDateString('es-ES',{month:'short'})}`;
            
            const dataS = dbVidaMinisterio.find(r => r.fecha >= toISODate(lunes) && r.fecha <= toISODate(domingo));
            const dataF = dbFinSemana.find(r => r.fecha >= toISODate(lunes) && r.fecha <= toISODate(domingo));

            document.getElementById('fecha-semana').textContent = rango;
            if (dataS) {
                const vida = parsearListaFlexible(dataS.vidaCristianaLista || "");
                document.getElementById('reunion-semana-detalle').innerHTML = `
                    <div class="info-box"><div><strong>Presidente:</strong> ${dataS.presidente || ""}</div></div>
                    <div class="tesoros re-block"><h4 class="section-heading">TESOROS</h4>${(dataS.tesorosPalabra||[]).map(i=>`<div class="reunion-timeline-item"><div class="reunion-timeline-dot"></div><div class="reunion-item-content"><strong>${i.titulo}</strong><br>${i.principal} ${i.auxiliar?`<span class="reunion-item-auxiliar">Segunda Sala: ${i.auxiliar}</span>`:''}</div></div>`).join('')}</div>
                    <div class="maestros re-block"><h4 class="section-heading">MAESTROS</h4>${(dataS.hagamosMejores||[]).map(i=>`<div class="reunion-timeline-item"><div class="reunion-timeline-dot"></div><div class="reunion-item-content"><strong>${i.titulo}</strong><br>${i.principal} ${i.auxiliar?`<span class="reunion-item-auxiliar">Segunda Sala: ${i.auxiliar}</span>`:''}</div></div>`).join('')}</div>
                    <div class="vida re-block"><h4 class="section-heading">VIDA CRISTIANA</h4>${vida.map(v => `<div class="reunion-timeline-item"><div class="reunion-timeline-dot"></div><div class="reunion-item-content"><strong>${v.rol}</strong><br>${v.nombre}</div></div>`).join('')}</div>
                    <div class="asignaciones-box"><div class="asignaciones-header">Asignaciones Mecánicas</div><table class="asignaciones-table">${parsearListaFlexible(dataS.asignacionesLista || "").map(a=>`<tr><td>${a.rol}</td><td>${a.nombre}</td></tr>`).join('')}</table></div>`;
            } else { document.getElementById('reunion-semana-detalle').innerHTML = `<div class="no-grupos">Sin programación.</div>`; }

            if (dataF) {
                const parts = dataF.fecha.split('-');
                document.getElementById('fecha-finde').textContent = new Date(parts[0], parts[1]-1, parts[2]).toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
                document.getElementById('reunion-finde-detalle').innerHTML = `
                    <div class="info-box"><div><strong>Presidente:</strong> ${dataF.presidente || ""}</div></div>
                    <div class="publico re-block"><h4 class="section-heading">DISCURSO</h4><div class="reunion-timeline-item"><div class="reunion-timeline-dot"></div><div class="reunion-item-content"><strong>${dataF.discursoPublico?.tema || ""}</strong><br>${dataF.discursoPublico?.orador || ""}</div></div></div>
                    <div class="atalaya re-block"><h4 class="section-heading">ATALAYA</h4><div class="reunion-timeline-item"><div class="reunion-timeline-dot"></div><div class="reunion-item-content"><strong>${dataF.estudioAtalaya?.articulo || ""}</strong><br>Lector: ${dataF.estudioAtalaya?.lector || ""}</div></div></div>
                    <div class="asignaciones-box"><div class="asignaciones-header">Asignaciones Mecánicas</div><table class="asignaciones-table">${parsearListaFlexible(dataF.asignacionesLista || "").map(a=>`<tr><td>${a.rol}</td><td>${a.nombre}</td></tr>`).join('')}</table></div>`;
            } else { document.getElementById('reunion-finde-detalle').innerHTML = `<div class="no-grupos">Sin programación.</div>`; }
        }

        function renderAnuncios() {
            const limpiar = (f) => { if(!f) return ""; const p = f.split('-'); return `${p[2]} ${new Date(p[0],p[1]-1,p[2]).toLocaleDateString('es-ES',{month:'short'}).toUpperCase().replace('.','')}`; };
            document.getElementById('anuncios-lista').innerHTML = dbAnuncios.map(a => `<div class="anuncio"><div class="anuncio-date">${limpiar(a.fechaInicio)}</div><div class="anuncio-text">${a.texto}</div></div>`).join('') || '<div class="no-grupos">Sin anuncios.</div>';
        }

        function renderAll() {
            document.getElementById('btn-today').style.display = toISODate(fechaSeleccionada) !== toISODate(fechaHoy) ? 'flex' : 'none';
            renderCalendarGrid(); renderCarousel(); renderGruposDia(); renderReuniones(); renderTodosGruposPaginados(); renderAnuncios();
        }

        function parsearListaFlexible(t) { return t.split('|').map(i => { const p = i.split(':'); return { rol: p[0].trim(), nombre: p[1]?.trim() || '' }; }); }

        function renderCalendarGrid() {
            const grid = document.getElementById('calendario-grid'); grid.innerHTML='';
            document.getElementById('calendar-month').textContent = fechaVisualizadaCalendario.toLocaleDateString('es-ES', {month:'long', year:'numeric'});
            ['D','L','M','M','J','V','S'].forEach(d=>grid.innerHTML+=`<div class="calendar-day-header">${d}</div>`);
            const first = new Date(fechaVisualizadaCalendario.getFullYear(), fechaVisualizadaCalendario.getMonth(), 1).getDay();
            const days = new Date(fechaVisualizadaCalendario.getFullYear(), fechaVisualizadaCalendario.getMonth()+1, 0).getDate();
            for(let i=0; i<first; i++) grid.innerHTML+=`<div></div>`;
            for(let i=1; i<=days; i++) {
                const d = document.createElement('div'); d.className='calendar-day'; d.textContent=i;
                const f = toISODate(new Date(fechaVisualizadaCalendario.getFullYear(), fechaVisualizadaCalendario.getMonth(), i));
                if(f === toISODate(fechaSeleccionada)) d.classList.add('selected');
                if(f === toISODate(fechaHoy)) d.classList.add('today');
                d.onclick=()=>{ fechaSeleccionada = new Date(fechaVisualizadaCalendario.getFullYear(), fechaVisualizadaCalendario.getMonth(), i); renderAll(); centrarSeleccion(); };
                grid.appendChild(d);
            }
        }

        function renderCarousel() {
            const c = document.getElementById('carousel'); c.innerHTML = '';
            for(let i=-2; i<=60; i++) {
                const f = new Date(fechaHoy); f.setDate(f.getDate() + i);
                const card = document.createElement('div'); card.className = `date-card ${toISODate(f) === toISODate(fechaSeleccionada) ? 'selected' : ''} ${toISODate(f) === toISODate(fechaHoy) ? 'is-today' : ''}`;
                card.dataset.date = toISODate(f);
                card.innerHTML = `<div class="date-card-day">${f.toLocaleDateString('es-ES',{weekday:'short'}).slice(0,3)}</div><div class="date-card-number">${f.getDate()}</div>`;
                card.onclick = () => { fechaSeleccionada = f; renderAll(); centrarSeleccion(); };
                c.appendChild(card);
            }
        }

        function renderTodosGruposPaginados() {
            const tl = document.getElementById('swipe-timeline');
            const lista = dbGrupos.filter(g => g.fecha >= toISODate(fechaHoy)).sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
            if(!lista.length) { tl.innerHTML='<div class="no-grupos">Sin grupos futuros.</div>'; return; }
            const paginas = Math.ceil(lista.length/diasPorPagina);
            const data = lista.slice((paginaGruposActual-1)*diasPorPagina, paginaGruposActual*diasPorPagina);
            tl.innerHTML = data.map(dia => `
                <div class="timeline-day-block ${toISODate(new Date(dia.fecha+"T12:00:00")) === toISODate(fechaSeleccionada) ? 'active-day' : ''}">
                    <div class="timeline-date-header">${new Date(dia.fecha+"T12:00:00").toLocaleDateString('es-ES',{weekday:'long', day:'numeric', month:'long'})}</div>
                    ${dia.grupos.map(g => `<div class="timeline-row"><div class="grupo-row-flex"><div class="gh-hora-timeline">${g.hora}</div><div class="grupo-content-col"><div class="gh-top-row"><div class="gh-territorio">${g.territorio}</div><div class="gh-conductor">${g.conductor}</div></div></div></div></div>`).join('')}
                </div>`).join('');
            const pag = document.getElementById('paginacion-container');
            pag.classList.remove('hidden');
            pag.innerHTML = `<button class="page-btn" ${paginaGruposActual===1?'disabled':''} onclick="paginaGruposActual--;renderTodosGruposPaginados()">❮</button>` + 
                            Array.from({length:paginas},(_,i)=>`<button class="page-btn ${i+1===paginaGruposActual?'active':''}" onclick="paginaGruposActual=${i+1};renderTodosGruposPaginados()">${i+1}</button>`).join('') +
                            `<button class="page-btn" ${paginaGruposActual===paginas?'disabled':''} onclick="paginaGruposActual++;renderTodosGruposPaginados()">❯</button>`;
        }

        function toggleSection(id) { 
            const c = document.getElementById(id + '-content'); sectionsExpanded[id] = !sectionsExpanded[id]; c.classList.toggle('expanded');
            if(id==='todos-grupos') { document.getElementById('ver-todos-text').textContent = sectionsExpanded[id] ? "Ocultar grupos" : "Ver todos los grupos"; renderTodosGruposPaginados(); }
            if(id==='calendario') document.getElementById('calendar-toggle-text').textContent = sectionsExpanded[id] ? "Ocultar calendario" : "Mostrar calendario";
        }

        function scrollCarousel(d) { document.getElementById('carousel').scrollBy({ left: d * 120, behavior: 'smooth' }); }
        function cambiarSemana(d) { semanaOffset += d; renderReuniones(); }
        function resetearSemana() { semanaOffset = 0; renderReuniones(); }
        function navMes(d) { fechaVisualizadaCalendario.setMonth(fechaVisualizadaCalendario.getMonth() + d); renderCalendarGrid(); }

        iniciarApp();
    </script>
</body>
</html>
