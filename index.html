<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cartelera Digital - La Cumaca</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        /* CAMBIO 1: Fondo blanco minimalista y colores reducidos */
        body { font-family: 'Inter', sans-serif; background: #ffffff; min-height: 100vh; padding: 16px; color: #374151; }
        .container { max-width: 480px; margin: 0 auto; padding-bottom: 40px; }
        /* Tarjetas m√°s limpias, sin blur, borde suave */
        .card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); margin-bottom: 24px; overflow: hidden; position: relative; }
        
        /* HEADER MINIMALISTA */
        .header { text-align: center; padding: 24px 16px 16px; }
        .header h1 { font-family: 'Inter', sans-serif; font-size: 26px; font-weight: 800; color: #166534; letter-spacing: -0.5px; line-height: 1.2; }
        
        /* NUEVO MEN√ö DE EMOJIS */
        .nav-menu { display: flex; justify-content: center; gap: 32px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #f3f4f6; }
        .nav-item { text-decoration: none; display: flex; flex-direction: column; align-items: center; color: #6b7280; transition: all 0.2s; cursor: pointer; }
        .nav-icon { font-size: 28px; margin-bottom: 4px; filter: grayscale(100%); opacity: 0.8; transition: all 0.2s; }
        .nav-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .nav-item:hover .nav-icon, .nav-item:active .nav-icon { filter: grayscale(0%); opacity: 1; transform: scale(1.1); }
        .nav-item:hover .nav-label { color: #16a34a; }

        /* T√çTULOS DE SECCI√ìN (Alineados a la izquierda) */
        .section-title-main { font-family: 'Inter', sans-serif; font-size: 20px; font-weight: 700; color: #1f2937; margin: 20px 20px 16px 20px; text-align: left; }
        
        .week-range-top { text-align: center; font-size: 13px; color: #6b7280; font-weight: 500; margin-top: 0px; margin-bottom: 16px; }

        /* CAROUSEL FECHAS (Scroll nativo para deslizar) */
        .carousel-wrapper { position: relative; padding: 0 20px 20px 20px; }
        /* Flechas ocultas en m√≥vil para fomentar el swipe */
        .carousel-arrow { position: absolute; top: 40%; transform: translateY(-50%); width: 32px; height: 32px; background: white; border-radius: 50%; border: 1px solid #e5e7eb; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        @media (hover: none) and (pointer: coarse) { .carousel-arrow { display: none; } } /* Ocultar en t√°ctil */
        .carousel-arrow:hover { background: #f0fdf4; border-color: #16a34a; }
        .carousel-arrow-left { left: 0px; } .carousel-arrow-right { right: 0px; }
        .carousel-arrow svg { width: 16px; height: 16px; stroke: #6b7280; fill: none; stroke-width: 2; }
        
        .carousel { 
            padding: 4px 0; display: flex; gap: 12px; 
            overflow-x: auto; /* Scroll nativo */
            scroll-snap-type: x mandatory; /* Ajuste suave */
            -webkit-overflow-scrolling: touch; /* Inercia en iOS */
            scrollbar-width: none; /* Ocultar barra Firefox */
        }
        .carousel::-webkit-scrollbar { display: none; /* Ocultar barra Chrome/Safari */ }

        .date-card { scroll-snap-align: center; min-width: 64px; padding: 12px 8px; border-radius: 14px; text-align: center; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; background: #f9fafb; border: 2px solid transparent; }
        .date-card.is-today { border: 2px solid #16a34a; background: #f0fdf4; }
        .date-card.selected { background: #16a34a; color: white; box-shadow: 0 4px 10px rgba(22, 163, 74, 0.2); transform: translateY(-2px); border-color: #16a34a; }
        .date-card-day { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; margin-bottom: 2px; }
        .date-card.selected .date-card-day { color: rgba(255,255,255,0.9); }
        .date-card-number { font-size: 22px; font-weight: 800; color: #1f2937; margin-bottom: 0; line-height: 1; }
        .date-card.selected .date-card-number { color: white; }

        /* CALENDARIO (Simplificado) */
        .calendar-toggle-wrapper { display: flex; justify-content: flex-end; padding-right: 20px; margin-top: -10px; margin-bottom: 10px; }
        .calendar-toggle { display: flex; align-items: center; gap: 4px; color: #16a34a; font-size: 13px; font-weight: 600; cursor: pointer; border: none; background: none; padding: 4px 8px; border-radius: 8px; transition: background 0.2s; }
        .section-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .section-content.expanded { max-height: 5000px; }
        .section-inner { padding: 0 20px 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .calendar-nav-btn { cursor: pointer; padding: 8px 12px; color: #16a34a; font-weight: bold; user-select: none; font-size: 16px; }
        .calendar-month { text-align: center; font-size: 15px; font-weight: 700; color: #374151; text-transform: capitalize; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day-header { text-align: center; font-size: 11px; font-weight: 700; color: #9ca3af; padding: 6px 0; }
        .calendar-day { text-align: center; padding: 8px 4px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; color: #374151; background: #f9fafb; }
        .calendar-day.selected { background: #16a34a !important; color: white !important; font-weight: 700; }
        .calendar-day.today { border: 2px solid #16a34a; color: #16a34a; font-weight: 700; background: #f0fdf4; }

        /* ESTILOS HORIZONTALES */
        .grupo-bloque-horizontal { display: flex; gap: 14px; align-items: flex-start; }
        .gh-hora { font-size: 13px; font-weight: 800; color: #16a34a; background: #f0fdf4; border: 1px solid #dcfce7; padding: 5px 0; border-radius: 8px; white-space: nowrap; flex-shrink: 0; width: 75px; text-align: center; margin: 0; line-height: 1.3; }
        .gh-info { flex-grow: 1; display: flex; flex-direction: column; gap: 4px; }
        .gh-fila-top { display: flex; flex-wrap: wrap; align-items: flex-start; gap: 8px; }
        .gh-territorio { font-size: 15px; font-weight: 700; color: #1f2937; line-height: 1.2; margin-top: 3px; }
        .gh-conductor { font-size: 13px; color: #6b7280; font-weight: 500; margin-top: 4px; }
        .gh-asignados { font-size: 13px; color: #15803d; font-weight: 700; }

        /* GRUPOS HOY (Tarjeta destacada limpia) */
        .grupos-dia-container { padding: 0 20px 20px; min-height: 100px; }
        .grupo-consolidado-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 16px; padding: 16px; }
        .grupo-consolidado-header { font-size: 14px; font-weight: 800; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .grupo-consolidado-header svg { color: #16a34a; }
        .grupo-item-hoy { border-bottom: 1px solid #e5e7eb; padding: 12px 0; }
        .grupo-item-hoy:last-child { border-bottom: none; padding-bottom: 0; }
        .grupo-item-hoy .gh-hora { background: white; border-color: #e5e7eb; }
        .no-grupos { text-align: center; padding: 32px 20px; color: #9ca3af; font-style: italic; }

        /* VER TODOS LOS GRUPOS */
        .ver-todos-btn { width: 100%; padding: 14px; background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; border-radius: 14px; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .ver-todos-btn:hover, .ver-todos-btn:active { background: #e5e7eb; color: #1f2937; }
        .ver-todos-btn svg { width: 18px; height: 18px; transition: transform 0.3s; color: #6b7280; }
        .ver-todos-btn.expanded svg { transform: rotate(180deg); }

        /* L√çNEA DE TIEMPO */
        .timeline-wrapper { padding-top: 10px; }
        .timeline-day-block { position: relative; padding-left: 24px; border-left: 2px solid #e5e7eb; padding-bottom: 24px; margin-left: 10px; }
        .timeline-day-block:last-child { border-left-color: transparent; }
        .timeline-date-header { position: relative; font-size: 15px; font-weight: 800; color: #1f2937; margin-bottom: 16px; text-transform: capitalize; line-height: 1; top: -4px; }
        .timeline-date-header::before { content: ''; position: absolute; left: -31px; top: 2px; width: 12px; height: 12px; background: #16a34a; border-radius: 50%; box-shadow: 0 0 0 4px white, 0 0 0 6px #16a34a; z-index: 1; }
        .timeline-row { position: relative; padding-bottom: 20px; }
        .timeline-row:last-child { padding-bottom: 0; }

        /* PAGINACI√ìN */
        .pagination-container { display: flex; justify-content: center; gap: 8px; margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb; }
        .page-btn { width: 36px; height: 36px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #374151; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .page-btn.active { background: #16a34a; color: white; border-color: #16a34a; }

        /* REUNIONES */
        .reunion-week-nav { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px; padding: 16px 12px; background: #f9fafb; border-radius: 16px; }
        .week-nav-arrow { width: 40px; height: 40px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .week-nav-arrow:active { background: #f3f4f6; }
        .week-nav-arrow svg { width: 20px; height: 20px; stroke: #6b7280; fill: none; stroke-width: 2; }
        /* ARREGLO CR√çTICO PARA "ESTA SEMANA" EN M√ìVIL */
        .week-nav-text { font-size: 18px; font-weight: 800; color: #1f2937; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; white-space: nowrap; /* Fuerza una l√≠nea */ }

        .reunion-card { border-radius: 18px; padding: 18px; border: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; margin-bottom: 20px; background: white; }
        .reunion-card:active { background: #f9fafb; }
        .reunion-card.active-card { border-color: #16a34a; box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.1); }
        .reunion-header { display: flex; justify-content: space-between; align-items: center; }
        .reunion-info h3 { font-weight: 700; color: #1f2937; margin-bottom: 6px; font-size: 17px; }
        .reunion-badge { display: inline-block; background: #16a34a; color: white; font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 12px; margin-left: 8px; text-transform: uppercase; }
        .reunion-date { font-size: 13px; color: #6b7280; margin-bottom: 4px; font-weight: 500; }
        .reunion-time { font-size: 14px; font-weight: 700; color: #16a34a; }
        .section-arrow { width: 22px; height: 22px; transition: transform 0.3s; fill: none; stroke: #9ca3af; stroke-width: 2; }
        .reunion-card.active-card .section-arrow { transform: rotate(180deg); stroke: #16a34a; }

        .reunion-timeline-item { position: relative; padding-left: 28px; padding-bottom: 20px; }
        .reunion-timeline-item::before { content: ''; position: absolute; left: 7px; top: 10px; bottom: -10px; width: 2px; background: #e5e7eb; }
        .reunion-timeline-item:last-child::before { display: none; }
        .reunion-timeline-dot { position: absolute; left: 0; top: 6px; width: 16px; height: 16px; border-radius: 50%; background: white; border: 3px solid #e5e7eb; z-index: 1; }
        /* Colores de puntos de reuni√≥n */
        .tesoros .reunion-timeline-dot { border-color: #059669; } .tesoros .section-heading { color: #059669; }
        .maestros .reunion-timeline-dot { border-color: #d97706; } .maestros .section-heading { color: #d97706; }
        .vida .reunion-timeline-dot { border-color: #dc2626; } .vida .section-heading { color: #dc2626; }
        .publico .reunion-timeline-dot { border-color: #7c3aed; } .publico .section-heading { color: #7c3aed; }
        .atalaya .reunion-timeline-dot { border-color: #0284c7; } .atalaya .section-heading { color: #0284c7; }
        
        .section-heading { font-size: 13px; font-weight: 800; margin-bottom: 6px; letter-spacing: 0.5px; text-transform: uppercase; }
        .reunion-item-content { font-size: 14px; color: #374151; line-height: 1.5; }
        .reunion-item-auxiliar { display: block; margin-top: 4px; font-size: 12px; color: #6b7280; font-style: italic; }
        .info-box { background: #f9fafb; border-radius: 12px; padding: 14px; margin-bottom: 20px; font-size: 14px; color: #374151; border: 1px solid #f3f4f6; }
        .asignaciones-box { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 14px; overflow: hidden; margin-top: 20px; }
        .asignaciones-header { background: #f9fafb; padding: 10px 16px; font-size: 13px; font-weight: 700; color: #374151; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; }
        .asignaciones-content { padding: 4px 16px; }
        .asignacion-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f3f4f6; font-size: 13px; }
        .asignacion-item:last-child { border-bottom: none; }

        /* ANUNCIOS */
        .anuncio { background: #fffbeb; border: 1px solid #fcd34d; border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; gap: 14px; align-items: flex-start; }
        .anuncio-date { background: #f59e0b; color: white; font-size: 11px; font-weight: 800; padding: 4px 8px; border-radius: 8px; white-space: nowrap; flex-shrink: 0; margin-top: 2px; }
        .anuncio-text { font-size: 14px; color: #374151; flex: 1; line-height: 1.5; font-weight: 500; }
        .footer { text-align: center; color: #9ca3af; font-size: 12px; margin-top: 32px; padding-bottom: 24px; border-top: 1px solid #f3f4f6; padding-top: 24px; }
        .hidden { display: none !important; }

        /* LOADING */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.4s ease; }
        .spinner { width: 40px; height: 40px; border: 3px solid #f3f4f6; border-top: 3px solid #16a34a; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-details { margin-top: 24px; color: #dc2626; font-family: monospace; font-size: 12px; background: #fef2f2; padding: 16px; border-radius: 12px; border: 1px solid #fee2e2; max-width: 90%; white-space: pre-wrap; }
        /* Clase para deshabilitar scroll vertical durante swipe horizontal */
        .no-scroll-y { overflow-y: hidden; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner" id="spinner"></div>
        <p id="loading-text" style="color:#374151; font-weight: 600; font-size: 14px;">Cargando cartelera...</p>
        <div id="error-details" class="hidden"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Cartelera de la Cong. La Cumaca</h1>
        </div>
        
        <div class="nav-menu">
            <a href="#grupos-section" class="nav-item">
                <span class="nav-icon">‚òÇÔ∏è</span>
                <span class="nav-label">Grupos</span>
            </a>
            <a href="#reuniones-section" class="nav-item">
                <span class="nav-icon">üìñ</span>
                <span class="nav-label">Reuniones</span>
            </a>
            <a href="#anuncios-section" class="nav-item">
                <span class="nav-icon">üì£</span>
                <span class="nav-label">Anuncios</span>
            </a>
        </div>

        <div class="card" id="grupos-section">
            <h2 class="section-title-main">Grupos de Predicaci√≥n</h2>
            <div class="week-range-top" id="week-text"></div>
            
            <div class="carousel-wrapper">
                <div class="carousel-arrow carousel-arrow-left" onclick="scrollCarousel(-1)"><svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></div>
                <div class="carousel-arrow carousel-arrow-right" onclick="scrollCarousel(1)"><svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></div>
                <div class="carousel" id="carousel"></div>
            </div>

            <div class="calendar-toggle-wrapper"><button class="calendar-toggle" onclick="toggleSection('calendario')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><span id="calendar-toggle-text">Calendario</span></button></div>
            <div class="section-content" id="calendario-content">
                <div class="section-inner"><div class="calendar-header"><div class="calendar-nav-btn" onclick="navMes(-1)">‚ùÆ</div><div class="calendar-month" id="calendar-month"></div><div class="calendar-nav-btn" onclick="navMes(1)">‚ùØ</div></div><div class="calendar-grid" id="calendario-grid"></div></div>
            </div>
            
            <div id="swipe-grupos-hoy" class="grupos-dia-container">
                <div id="grupos-dia-content"></div>
            </div>
            
            <div style="padding: 0 20px 20px;"><button class="ver-todos-btn" id="ver-todos-btn" onclick="toggleSection('todos-grupos')"><span id="ver-todos-text">Ver todos los grupos</span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></button></div>
            <div class="section-content" id="todos-grupos-content">
                <div class="section-inner">
                    <div id="todos-grupos-timeline" class="timeline-wrapper"></div>
                    <div id="paginacion-container" class="pagination-container hidden"></div>
                </div>
            </div>
        </div>

        <h2 class="section-title-main" id="reuniones-section">Programa de Reuniones</h2>
        <div class="card" style="padding: 20px;">
            <div id="swipe-reuniones-semana" class="reunion-week-nav">
                <div class="week-nav-arrow" onclick="cambiarSemana(-1)"><svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></div>
                <div class="week-nav-text" onclick="resetearSemana()">ESTA SEMANA</div>
                <div class="week-nav-arrow" onclick="cambiarSemana(1)"><svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></div>
            </div>
            
            <div class="reunion-card" id="card-reunion-semana" onclick="toggleSection('reunion-semana')">
                <div class="reunion-header">
                    <div class="reunion-info"><h3>Reuni√≥n Entre Semana <span class="reunion-badge hidden" id="badge-semana">HOY</span></h3><p class="reunion-date" id="fecha-semana"></p><p class="reunion-time">Jueves 6:30 PM</p></div>
                    <svg class="section-arrow" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                </div>
            </div>
            <div class="section-content" id="reunion-semana-content"><div class="section-inner" id="reunion-semana-detalle"></div></div>
            
            <div class="reunion-card" id="card-reunion-finde" onclick="toggleSection('reunion-finde')">
                <div class="reunion-header">
                    <div class="reunion-info"><h3>Reuni√≥n Fin de Semana <span class="reunion-badge hidden" id="badge-finde">HOY</span></h3><p class="reunion-date" id="fecha-finde"></p><p class="reunion-time">Domingo 10:00 AM</p></div>
                    <svg class="section-arrow" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                </div>
            </div>
            <div class="section-content" id="reunion-finde-content"><div class="section-inner" id="reunion-finde-detalle"></div></div>
        </div>

        <h2 class="section-title-main" id="anuncios-section">Anuncios</h2>
        <div class="card" style="padding: 20px;">
            <div id="anuncios-lista"></div>
        </div>
        <div class="footer"><p>Actualizaci√≥n autom√°tica ‚Ä¢ Conectado</p><p id="data-stats" style="font-size: 11px; color: #9ca3af; margin-top:6px;"></p></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxWQCoBctEYLdVGexgwcu4z_mXzym78f1EZnTQi4HkjzSil18chRBM-qgt7xhQEqaOX/exec"; 

        let dbGrupos = [], dbVidaMinisterio = [], dbFinSemana = [], dbAnuncios = [];
        let fechaHoy = new Date();
        let fechaSeleccionada = new Date(fechaHoy);
        let fechaVisualizadaCalendario = new Date(fechaHoy);
        let semanaOffset = 0;
        let sectionsExpanded = {};
        let paginaGruposActual = 1;
        const diasPorPagina = 3; 

        function toISODate(d) {
            if(!(d instanceof Date)) return "";
            return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        }

        async function iniciarApp() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Error HTTP: " + response.status);
                const data = await response.json();
                if (data.error) throw new Error(data.message);
                
                dbGrupos = data.grupos || [];
                dbVidaMinisterio = data.vidaMinisterio || [];
                dbFinSemana = data.finSemana || [];
                dbAnuncios = data.anuncios || [];

                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);

                const total = dbGrupos.length + dbVidaMinisterio.length + dbFinSemana.length;
                document.getElementById('data-stats').textContent = `Registros cargados: ${total}`;
                renderAll();
                setupSwipeGestures(); // Iniciar detecci√≥n de gestos
            } catch (error) {
                console.error(error);
                document.getElementById('spinner').style.display = 'none';
                document.getElementById('loading-text').textContent = "No se pudo conectar";
                document.getElementById('loading-text').style.color = "#dc2626";
                const errDetails = document.getElementById('error-details');
                errDetails.classList.remove('hidden');
                errDetails.textContent = "Detalles: " + error.message;
            }
        }

        // --- FUNCIONES DE GESTOS T√ÅCTILES (SWIPE) ---
        function setupSwipeGestures() {
            // Swipe en tarjeta de grupos de hoy (Cambiar d√≠a)
            setupSwipe('swipe-grupos-hoy', () => cambiarDiaSeleccionado(1), () => cambiarDiaSeleccionado(-1));
            // Swipe en navegaci√≥n de semana (Cambiar semana)
            setupSwipe('swipe-reuniones-semana', () => cambiarSemana(1), () => cambiarSemana(-1));
        }

        function setupSwipe(elementId, onSwipeLeft, onSwipeRight) {
            const element = document.getElementById(elementId);
            if (!element) return;
            let touchStartX = 0; let touchStartY = 0;
            element.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, {passive: true});
            element.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;
                // Detectar solo si es movimiento horizontal predominante
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    if (diffX > 0) onSwipeLeft(); else onSwipeRight();
                }
            }, {passive: true});
        }

        function cambiarDiaSeleccionado(d) {
            fechaSeleccionada.setDate(fechaSeleccionada.getDate() + d);
            renderAll();
        }
        // -------------------------------------------

        function esMismoDia(f1, f2) {
            const str1 = f1 instanceof Date ? toISODate(f1) : f1;
            const str2 = f2 instanceof Date ? toISODate(f2) : f2;
            return str1 === str2;
        }

        function renderGruposDia() {
            const container = document.getElementById('grupos-dia-content');
            const fechaStr = toISODate(fechaSeleccionada);
            const data = dbGrupos.find(g => g.fecha === fechaStr);
            
            if (!data || !data.grupos || data.grupos.length === 0) {
                container.innerHTML = `<div class="no-grupos">No hay grupos programados para este d√≠a.</div>`;
                return;
            }
            let htmlInner = '';
            data.grupos.forEach(g => {
                htmlInner += `
                <div class="grupo-item-hoy">
                    <div class="grupo-bloque-horizontal">
                        <div class="gh-hora">${g.hora}</div>
                        <div class="gh-info">
                            <div class="gh-fila-top">
                                <div class="gh-territorio">${g.territorio}</div>
                            </div>
                            <div class="gh-conductor">${g.conductor}</div>
                            ${g.gruposAssigned ? `<div class="gh-asignados">${g.gruposAssigned}</div>` : ''}
                        </div>
                    </div>
                </div>`;
            });
            const diaSemana = fechaSeleccionada.toLocaleDateString('es-ES', { weekday: 'long' });
            container.innerHTML = `<div class="grupo-consolidado-card"><div class="grupo-consolidado-header"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>Grupos del ${diaSemana}</div>${htmlInner}</div>`;
        }

        function renderReuniones() {
            const d = new Date(fechaHoy);
            const day = d.getDay();
            const diff = d.getDate() - day + (day == 0 ? -6 : 1) + (semanaOffset * 7);
            const lunes = new Date(d.setDate(diff));
            const lunesStr = toISODate(lunes);
            const domingo = new Date(lunes); domingo.setDate(lunes.getDate() + 6);
            const domingoStr = toISODate(domingo);

            const buscar = (lista) => lista.find(r => r.fecha >= lunesStr && r.fecha <= domingoStr);
            const dataSemana = buscar(dbVidaMinisterio);
            const dataFinde = buscar(dbFinSemana);

            const containerSemana = document.getElementById('reunion-semana-detalle');
            const fechaSemanaEl = document.getElementById('fecha-semana');
            const badgeSemana = document.getElementById('badge-semana');

            if (dataSemana) {
                fechaSemanaEl.textContent = formatearFecha(dataSemana.fecha);
                esMismoDia(dataSemana.fecha, fechaHoy) ? badgeSemana.classList.remove('hidden') : badgeSemana.classList.add('hidden');
                const asig = parsearListaFlexible(dataSemana.asignacionesLista || "");
                const vida = parsearListaFlexible(dataSemana.vidaCristianaLista || "");
                
                containerSemana.innerHTML = `
                    <div class="info-box"><div><strong>Presidente:</strong> ${dataSemana.presidente || ""}</div><div><strong>Oraci√≥n inicial:</strong> ${dataSemana.oracionInicial || ""}</div></div>
                    <div class="tesoros"><h4 class="section-heading">TESOROS DE LA BIBLIA</h4>${(dataSemana.tesorosPalabra||[]).map(i=>`<div class="reunion-timeline-item"><div class="reunion-timeline-dot"></div><div class="reunion-item-content"><strong>${i.titulo}</strong><br>${i.principal} ${i.auxiliar?`<span class="reunion-item-auxiliar">Sala B: ${i.auxiliar}</span>`:''}</div></div>`).join('')}</div>
                    <div class="maestros"><h4 class="section-heading">SEAMOS MEJORES MAESTROS</h4>${(dataSemana.hagamosMejores||[]).map(i=>`<div class="reunion-timeline-item"><div class="reunion-timeline-dot"></div><div class="reunion-item-content"><strong>${i.titulo}</strong><br>${i.principal} ${i.auxiliar?`<span class="reunion-item-auxiliar">Sala B: ${i.auxiliar}</span>`:''}</div></div>`).join('')}</div>
                    <div class="vida"><h4 class="section-heading">NUESTRA VIDA CRISTIANA</h4>${vida.map(v => `<div class="reunion-timeline-item"><div class="reunion-timeline-dot"></div><div class="reunion-item-content"><strong>${v.rol}</strong><br>${v.nombre}</div></div>`).join('')}</div>
                    <div class="info-box"><div><strong>Oraci√≥n final:</strong> ${dataSemana.oracionFinal || ""}</div></div>
                    <div class="asignaciones-box"><div class="asignaciones-header">Asignaciones Auxiliares</div><div class="asignaciones-content">${asig.map(a=>`<div class="asignacion-item"><div>${a.rol}</div><div>${a.nombre}</div></div>`).join('')}</div></div>`;
            } else {
                fechaSemanaEl.textContent = "No hay datos disponibles";
                badgeSemana.classList.add('hidden');
                containerSemana.innerHTML = `<div class="no-grupos">Sin programaci√≥n.</div>`;
            }

            const containerFinde = document.getElementById('reunion-finde-detalle');
            const fechaFindeEl = document.getElementById('fecha-finde');
            const badgeFinde = document.getElementById('badge-finde');

            if (dataFinde) {
                fechaFindeEl.textContent = formatearFecha(dataFinde.fecha);
                esMismoDia(dataFinde.fecha, fechaHoy) ? badgeFinde.classList.remove('hidden') : badgeFinde.classList.add('hidden');
                const asig = parsearListaFlexible(dataFinde.asignacionesLista || "");
                containerFinde.innerHTML = `
                    <div class="info-box"><div><strong>Presidente:</strong> ${dataFinde.presidente || ""}</div><div><strong>Oraci√≥n inicial:</strong> ${dataFinde.oracionInicial || ""}</div></div>
                    <div class="publico"><h4 class="section-heading">DISCURSO P√öBLICO</h4><div class="reunion-timeline-item"><div class="reunion-timeline-dot"></div><div class="reunion-item-content"><strong>${dataFinde.discursoPublico?.tema || ""}</strong><br>${dataFinde.discursoPublico?.orador || ""}<br><span class="reunion-item-auxiliar">Cong. ${dataFinde.discursoPublico?.congregacion || ""}</span></div></div></div>
                    <div class="atalaya"><h4 class="section-heading">ESTUDIO DE LA ATALAYA</h4><div class="reunion-timeline-item"><div class="reunion-timeline-dot"></div><div class="reunion-item-content"><strong>${dataFinde.estudioAtalaya?.articulo || ""}</strong><br>Conductor: ${dataFinde.estudioAtalaya?.conductor || ""}<br>Lector: ${dataFinde.estudioAtalaya?.lector || ""}</div></div></div>
                    <div class="info-box"><div><strong>Oraci√≥n final:</strong> ${dataFinde.oracionFinal || ""}</div></div>
                    ${asig.length > 0 ? `<div class="asignaciones-box"><div class="asignaciones-header">Otras Asignaciones</div><div class="asignaciones-content">${asig.map(a=>`<div class="asignacion-item"><div>${a.rol}</div><div>${a.nombre}</div></div>`).join('')}</div></div>` : ''}`;
            } else {
                fechaFindeEl.textContent = "No hay datos disponibles";
                badgeFinde.classList.add('hidden');
                containerFinde.innerHTML = `<div class="no-grupos">Sin programaci√≥n.</div>`;
            }
        }

        function renderAnuncios() {
            const limpiar = (f) => {
                if(!f) return "";
                const parts = f.split('-');
                if(parts.length === 3) {
                    const d = new Date(parts[0], parts[1]-1, parts[2]);
                    const mes = d.toLocaleDateString('es-ES', { month: 'short' }).toUpperCase().replace('.', '');
                    return `${d.getDate()} ${mes}`;
                }
                return f;
            };
            const html = dbAnuncios.map(a => `<div class="anuncio"><div class="anuncio-date">${limpiar(a.fechaInicio)} ${a.fechaFin ? '- ' + limpiar(a.fechaFin) : ''}</div><div class="anuncio-text">${a.texto}</div></div>`).join('');
            document.getElementById('anuncios-lista').innerHTML = html || '<div class="no-grupos">No hay anuncios recientes.</div>';
        }

        function renderAll() {
            const d = new Date(fechaSeleccionada);
            const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
            const mon = new Date(d.setDate(diff)); const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
            document.getElementById('week-text').textContent = `Semana del ${mon.getDate()} de ${mon.toLocaleDateString('es-ES',{month:'long'})} al ${sun.getDate()} de ${sun.toLocaleDateString('es-ES',{month:'long'})}`;
            renderCalendarGrid();
            renderCarousel();
            renderGruposDia();
            renderReuniones();
            paginaGruposActual = 1;
            renderTodosGruposPaginados();
            renderAnuncios();
        }

        function formatearFecha(fInput) { 
            if(!fInput) return "";
            const parts = fInput.split('-');
            const d = new Date(parts[0], parts[1]-1, parts[2]);
            return d.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }
        function parsearListaFlexible(t) { if (!t) return []; return t.split('|').map(i => { const p = i.split(':'); if (p.length > 1) return { rol: p[0].trim(), nombre: p.slice(1).join(':').trim() }; return { rol: i.trim(), nombre: '' }; }); }
        
        function renderCalendarGrid() {
            document.getElementById('calendar-month').textContent = fechaVisualizadaCalendario.toLocaleDateString('es-ES', {month:'long', year:'numeric'});
            const grid = document.getElementById('calendario-grid'); grid.innerHTML='';
            ['D','L','M','M','J','V','S'].forEach(d=>grid.innerHTML+=`<div class="calendar-day-header">${d}</div>`);
            const first = new Date(fechaVisualizadaCalendario.getFullYear(), fechaVisualizadaCalendario.getMonth(), 1);
            const days = new Date(fechaVisualizadaCalendario.getFullYear(), fechaVisualizadaCalendario.getMonth()+1, 0).getDate();
            for(let i=0; i<first.getDay(); i++) grid.innerHTML+=`<div></div>`;
            for(let i=1; i<=days; i++) {
                let d = document.createElement('div'); d.className='calendar-day'; d.textContent=i;
                const fStr = `${fechaVisualizadaCalendario.getFullYear()}-${String(fechaVisualizadaCalendario.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                if(fStr === toISODate(fechaSeleccionada)) d.classList.add('selected');
                if(fStr === toISODate(fechaHoy)) d.classList.add('today');
                d.onclick=()=>{ fechaSeleccionada = new Date(fechaVisualizadaCalendario.getFullYear(), fechaVisualizadaCalendario.getMonth(), i); renderAll(); };
                grid.appendChild(d);
            }
        }
        
        function renderCarousel() {
            const c = document.getElementById('carousel'); c.innerHTML = '';
            const b = new Date(fechaSeleccionada);
            for(let i=-10; i<=10; i++) {
                const f = new Date(b); f.setDate(b.getDate() + i);
                const card = document.createElement('div');
                card.className = `date-card ${esMismoDia(f, fechaSeleccionada) ? 'selected' : ''} ${esMismoDia(f, fechaHoy) ? 'is-today' : ''}`;
                card.innerHTML = `<div class="date-card-day">${f.toLocaleDateString('es-ES',{weekday:'short'}).slice(0,3)}</div><div class="date-card-number">${f.getDate()}</div>`;
                card.onclick = () => { fechaSeleccionada = f; renderAll(); c.scrollTo({ left: card.offsetLeft - c.offsetWidth/2 + card.offsetWidth/2, behavior: 'smooth' }); };
                c.appendChild(card);
            }
            // Auto-scroll al seleccionado
            setTimeout(() => { const s = c.querySelector('.selected'); if(s) c.scrollTo({ left: s.offsetLeft - c.offsetWidth/2 + s.offsetWidth/2, behavior: 'smooth' }); }, 100);
        }
        
        function renderTodosGruposPaginados() {
            const tl = document.getElementById('todos-grupos-timeline');
            const pagContainer = document.getElementById('paginacion-container');
            tl.innerHTML = ''; pagContainer.innerHTML = '';
            let listaFechas = [...dbGrupos]; listaFechas.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
            if (listaFechas.length === 0) { tl.innerHTML = '<div class="no-grupos">No hay datos futuros.</div>'; pagContainer.classList.add('hidden'); return; }
            const totalPaginas = Math.ceil(listaFechas.length / diasPorPagina);
            if (paginaGruposActual > totalPaginas) paginaGruposActual = 1;
            const inicio = (paginaGruposActual - 1) * diasPorPagina;
            const fechasPagina = listaFechas.slice(inicio, inicio + diasPorPagina);
            fechasPagina.forEach(diaData => {
                const fechaNice = formatearFecha(diaData.fecha);
                const dayBlock = document.createElement('div'); dayBlock.className = 'timeline-day-block';
                const header = document.createElement('div'); header.className = 'timeline-date-header'; header.textContent = fechaNice;
                dayBlock.appendChild(header);
                diaData.grupos.forEach(g => {
                    const row = document.createElement('div'); row.className = 'timeline-row';
                    row.innerHTML = `<div class="grupo-bloque-horizontal"><div class="gh-hora">${g.hora}</div><div class="gh-info"><div class="gh-fila-top"><div class="gh-territorio">${g.territorio}</div></div><div class="gh-conductor">${g.conductor}</div>${g.gruposAssigned ? `<div class="gh-asignados">${g.gruposAssigned}</div>` : ''}</div></div>`;
                    dayBlock.appendChild(row);
                });
                tl.appendChild(dayBlock);
            });
            if (totalPaginas > 1) {
                pagContainer.classList.remove('hidden');
                for (let i = 1; i <= totalPaginas; i++) {
                    const btn = document.createElement('button'); btn.className = `page-btn ${i === paginaGruposActual ? 'active' : ''}`; btn.textContent = i;
                    btn.onclick = () => { paginaGruposActual = i; renderTodosGruposPaginados(); }; pagContainer.appendChild(btn);
                }
            } else { pagContainer.classList.add('hidden'); }
        }
        
        function toggleSection(id) { 
            const c = document.getElementById(id + '-content'); 
            const card = document.getElementById('card-' + id);
            sectionsExpanded[id] = !sectionsExpanded[id]; 
            c.classList.toggle('expanded'); 
            if (card) card.classList.toggle('active-card');
            if(id === 'todos-grupos') { 
                const btnText = document.getElementById('ver-todos-text');
                const btn = document.getElementById('ver-todos-btn');
                if (sectionsExpanded[id]) { btnText.textContent = "Ocultar grupos"; btn.classList.add('expanded'); paginaGruposActual = 1; renderTodosGruposPaginados(); } else { btnText.textContent = "Ver todos los grupos"; btn.classList.remove('expanded'); }
            } 
        }

        function scrollCarousel(d) { document.getElementById('carousel').scrollBy({ left: d * 120, behavior: 'smooth' }); }
        function cambiarSemana(d) { semanaOffset += d; renderReuniones(); }
        function resetearSemana() { semanaOffset = 0; renderReuniones(); }
        function navMes(d) { fechaVisualizadaCalendario.setMonth(fechaVisualizadaCalendario.getMonth() + d); renderCalendarGrid(); }

        iniciarApp();
    </script>
</body>
</html>
