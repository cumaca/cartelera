<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cartelera Digital - La Cumaca</title>
    <style>
        /* --- ESTILOS BASE --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, button, input, select, textarea { 
            font-family: 'Roboto', sans-serif; 
        }
        
        body { background: #fcfcfc; min-height: 100vh; padding: 16px; color: #4b5563; overflow-x: hidden; }
        
        .container { max-width: 480px; margin: 0 auto; padding-bottom: 100px; padding-top: 10px; }
        
        /* TARJETAS GENERALES */
        .card { 
            background: #ffffff; 
            border: none; 
            border-radius: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); 
            margin-bottom: 50px; 
            overflow: hidden; 
            position: relative; 
        }

        /* --- NAVEGACI√ìN --- */
        .nav-segment-container { 
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #ffffff; border-top: 1px solid #e5e7eb;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            display: flex; justify-content: space-around; padding: 10px 0;
        }
        .nav-segment { display: contents; }
        .nav-btn { 
            text-decoration: none; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; gap: 4px; flex: 1;
            color: #9ca3af; font-size: 11px; font-weight: 600; padding: 4px;
            border-radius: 8px; transition: all 0.2s;
        }
        .nav-btn:hover { color: #1f2937; background: #f9fafb; }
        .nav-btn svg { width: 22px; height: 22px; stroke-width: 2; margin-bottom: 2px; }
        .nav-divider { display: none; }

        @media (min-width: 768px) {
            .nav-segment-container { 
                position: static; border: none; box-shadow: none; 
                margin-bottom: 32px; padding: 0; background: transparent;
                justify-content: center;
            }
            .nav-segment { display: inline-flex; background: #e5e7eb; border-radius: 12px; padding: 4px; }
            .nav-btn { flex-direction: row; flex: initial; gap: 6px; padding: 8px 16px; font-size: 13px; color: #6b7280; }
            .nav-btn svg { width: 16px; height: 16px; margin: 0; }
            .nav-divider { display: block; width: 1px; height: 14px; background: #d1d5db; margin: 0 2px; }
            .container { padding-bottom: 60px; }
        }

        /* T√çTULOS EXTERNOS - M√ÅS OSCUROS Y NO EN MAY√öSCULAS */
        .section-title-main { 
            font-size: 18px; 
            font-weight: 900; 
            color: #1f2937; /* Gris mucho m√°s oscuro */
            margin: 40px 0 20px 8px; 
            text-align: left; 
            letter-spacing: 0.2px;
        }
        
        h2.section-title-main:first-of-type { margin-top: 10px; }

        .month-indicator { margin: 20px 0 16px 20px; font-size: 13px; font-weight: 800; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; display: inline-block; }

        /* CARRUSEL */
        .carousel-wrapper { position: relative; padding: 0 10px 20px 10px; margin-top: 10px;}
        
        .carousel-wrapper::before, .carousel-wrapper::after {
            content: ''; position: absolute; top: 0; bottom: 20px; width: 60px; z-index: 5; pointer-events: none;
        }
        .carousel-wrapper::before { left: 0; background: linear-gradient(to right, #ffffff 20%, rgba(255,255,255,0) 100%); }
        .carousel-wrapper::after { right: 0; background: linear-gradient(to left, #ffffff 20%, rgba(255,255,255,0) 100%); }

        .carousel-arrow { 
            position: absolute; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; 
            background: white; border-radius: 50%; border: 1px solid #e5e7eb; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; z-index: 10; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.05); color: #6b7280;
        }
        .carousel-arrow-left { left: 4px; } .carousel-arrow-right { right: 4px; }
        
        .btn-today-floating {
            position: absolute; top: -35px; right: 20px; background: white; border: 1px solid #16a34a; color: #16a34a;
            font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 20px; cursor: pointer; display: none; 
            align-items: center; gap: 4px; box-shadow: 0 2px 8px rgba(22, 163, 74, 0.15); animation: fadeIn 0.3s ease; z-index: 20;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .carousel { padding: 10px 24px 4px 24px; display: flex; gap: 10px; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .carousel::-webkit-scrollbar { display: none; }
        .date-card { scroll-snap-align: center; min-width: 60px; padding: 10px 6px; border-radius: 14px; text-align: center; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; background: #f9fafb; border: 1px solid transparent; }
        .date-card.is-today { border: 2px solid #16a34a; background: #ffffff; }
        .date-card.selected { background: #16a34a; color: white; box-shadow: 0 4px 10px rgba(22, 163, 74, 0.25); transform: translateY(-2px); border-color: #16a34a; }
        .date-card-day { font-size: 10px; font-weight: 600; text-transform: uppercase; margin-bottom: 2px; opacity: 0.8; }
        .date-card-number { font-size: 20px; font-weight: 800; line-height: 1; }

        /* CALENDARIO */
        .calendar-toggle-wrapper { display: flex; justify-content: flex-end; padding-right: 20px; margin-top: -10px; margin-bottom: 10px; }
        .calendar-toggle { display: flex; align-items: center; gap: 6px; color: #16a34a; font-size: 12px; font-weight: 700; cursor: pointer; border: none; background: none; padding: 6px 10px; border-radius: 8px; }
        .calendar-toggle svg { width: 16px; height: 16px; }
        .section-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .section-content.expanded { max-height: 5000px; }
        .section-inner { padding: 0 20px 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px; }
        .calendar-nav-btn { cursor: pointer; padding: 8px 12px; color: #4b5563; font-weight: bold; }
        .calendar-month { font-size: 14px; font-weight: 700; color: #374151; text-transform: capitalize; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
        .calendar-day-header { text-align: center; font-size: 11px; font-weight: 700; color: #374151; padding: 4px 0; }
        .calendar-day { text-align: center; padding: 8px 4px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; color: #374151; background: #f9fafb; }
        .calendar-day.selected { background: #16a34a !important; color: white !important; font-weight: 700; }
        .calendar-day.today { border: 1px solid #16a34a; color: #16a34a; font-weight: 700; }

        /* GRUPOS */
        .grupos-dia-container { padding: 0 20px 20px; }
        .grupo-consolidado-card { background: #f9fafb; border-radius: 16px; padding: 16px; border: 1px solid #e5e7eb; }
        .grupo-consolidado-header { font-size: 13px; font-weight: 800; color: #374151; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .grupo-item-hoy { padding-bottom: 16px; border-bottom: 1px solid #e5e7eb; margin-bottom: 16px; }
        .grupo-item-hoy:last-child { padding-bottom: 0; border-bottom: none; margin-bottom: 0; }
        .gh-hora-hoy { font-size: 13px; font-weight: 800; color: #6b7280; background: #ffffff; border: 1px solid #d1d5db; padding: 6px 0; border-radius: 8px; white-space: nowrap; flex-shrink: 0; width: 70px; text-align: center; line-height: 1.3; }
        .grupo-row-flex { display: flex; gap: 14px; align-items: flex-start; }
        .grupo-content-col { flex-grow: 1; }
        .gh-top-row { display: flex; flex-wrap: wrap; align-items: baseline; gap: 8px; }
        .gh-territorio { font-size: 15px; font-weight: 700; color: #374151; line-height: 1.2; margin-top: 3px; }
        .gh-conductor { font-size: 13px; color: #6b7280; font-weight: 500; }
        .gh-asignados { font-size: 13px; color: #6b7280; font-weight: 600; margin-top: 4px; display: flex; align-items: center; flex-wrap: wrap; }
        .no-grupos { text-align: center; padding: 20px; color: #9ca3af; font-style: italic; font-size: 13px; }
        .ver-todos-wrapper { display: flex; justify-content: center; padding: 0 20px 20px; }
        .ver-todos-btn { width: 100%; padding: 12px 24px; background: transparent; color: #16a34a; border: 1px solid #16a34a; border-radius: 12px; font-size: 13px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .ver-todos-btn svg { width: 16px; height: 16px; transition: transform 0.3s; color: #16a34a; }
        .ver-todos-btn.expanded svg { transform: rotate(180deg); }

        /* TIMELINE HISTORIAL */
        .timeline-wrapper { padding-top: 10px; margin-left: 10px; } 
        .timeline-day-block { position: relative; padding-left: 28px; border-left: 2px solid #e5e7eb; padding-bottom: 30px; transition: all 0.3s; }
        .timeline-day-block:last-child { border-left: 2px solid transparent; border-image: linear-gradient(to bottom, #e5e7eb 0%, transparent 100%) 1 100%; }
        .timeline-date-header { position: relative; font-size: 15px; font-weight: 800; color: #9ca3af; margin-bottom: 16px; text-transform: capitalize; line-height: 1; top: -5px; }
        .timeline-date-header::before { content: ''; position: absolute; left: -35px; top: 1px; width: 12px; height: 12px; background: #9ca3af; border-radius: 50%; box-shadow: 0 0 0 4px rgba(156, 163, 175, 0.15); z-index: 1; }
        .timeline-day-block.active-day .timeline-date-header { color: #16a34a; }
        .timeline-day-block.active-day .timeline-date-header::before { background: #16a34a; box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.2); }
        .timeline-day-block.active-day .gh-hora-timeline { color: #16a34a; border-color: #16a34a; background: #f0fdf4; }
        
        /* MAYOR SEPARACI√ìN ENTRE GRUPOS DEL HISTORIAL */
        .timeline-row { margin-bottom: 24px; }
        .timeline-row:last-child { margin-bottom: 0; }
        
        .gh-hora-timeline { font-size: 13px; font-weight: 700; color: #9ca3af; background: #f9fafb; border: 1px solid #e5e7eb; padding: 6px 0; border-radius: 8px; white-space: nowrap; flex-shrink: 0; width: 70px; text-align: center; }
        .pagination-container { display: flex; justify-content: center; gap: 8px; margin-top: 20px; padding-top: 16px; border-top: 1px solid #f3f4f6; }
        .page-btn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb; background: white; color: #6b7280; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .page-btn.active { background: #16a34a; color: white; border-color: #16a34a; }

        /* REUNIONES NAV */
        .reunion-week-nav { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 4px; padding: 12px; }
        .week-nav-arrow { width: 36px; height: 36px; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #16a34a; }
        .week-nav-arrow svg { stroke: #16a34a; }
        .week-nav-text { font-size: 15px; font-weight: 800; color: #16a34a; text-transform: capitalize; cursor: pointer; white-space: nowrap; }
        
        /* CAJAS DE AVISO (SWIPE HINTS) MINIMALISTAS Y FINAS */
        .swipe-hint-box {
            background-color: #f3f4f6; /* Fondo gris claro */
            border: none; /* Sin borde oscuro */
            border-radius: 12px; /* Mismo redondeo que 'Ver todos' */
            padding: 4px 12px; /* MUCHO MENOS alto verticalmente */
            display: flex;
            width: fit-content; /* Solo el espacio necesario horizontalmente */
            margin: 0 auto 20px auto; 
            align-items: center;
            gap: 8px;
            box-shadow: none; /* Sin sombras */
            transition: opacity 0.3s ease;
        }
        .swipe-hint-content {
            display: flex; align-items: center; gap: 8px;
        }
        .swipe-hint-icon {
            width: 24px; height: 24px; 
            color: #6b7280; /* Gris */
            animation: fingerSwipeLeft 2.5s infinite ease-in-out;
        }
        .swipe-hint-text {
            font-size: 12px; color: #6b7280; font-weight: 600; /* Gris */
        }
        .swipe-hint-close {
            background: none; border: none; cursor: pointer;
            color: #9ca3af; width: 22px; height: 22px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: all 0.2s; margin-left: 4px;
        }
        .swipe-hint-close:hover { background: #e5e7eb; color: #4b5563; }
        
        /* Animaci√≥n deslizando de derecha a izquierda */
        @keyframes fingerSwipeLeft {
            0% { transform: translateX(10px); opacity: 0; }
            20% { transform: translateX(10px); opacity: 1; }
            60% { transform: translateX(-15px); opacity: 1; }
            80% { transform: translateX(-15px); opacity: 0; }
            100% { transform: translateX(10px); opacity: 0; }
        }

        @keyframes animFadeUp {
            0% { transform: translateY(5px); opacity: 0.2; }
            50% { transform: translateY(-2px); opacity: 1; }
            100% { transform: translateY(5px); opacity: 0.2; }
        }
        .fade-up-anim { animation: animFadeUp 1.5s infinite ease-in-out; }

        /* CARD REUNIONES */
        .reunion-card { 
            border-radius: 16px; 
            padding: 0; 
            border: 1px solid #f3f4f6; 
            cursor: pointer; 
            margin: 0 4px 20px 4px; 
            background: #fdfdfd; 
            transition: all 0.3s; 
        }
        
        .reunion-card.active-card { 
            border: 1px solid #e5e7eb; 
            border-radius: 12px; 
            background: #ffffff; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.02); 
            margin-bottom: 30px; 
        }
        
        .reunion-header-click {
            padding: 20px;
            display: flex; justify-content: space-between; align-items: flex-start;
            transition: background-color 0.3s ease;
            border-radius: 12px;
        }

        .reunion-card.active-card .reunion-header-click {
            background-color: #f9fafb; 
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .reunion-info h3 { font-weight: 800; color: #6b7280; margin-bottom: 6px; font-size: 16px; }
        .reunion-badge { display: inline-block; background: #16a34a; color: white; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 6px; margin-left: 6px; text-transform: uppercase; vertical-align: middle; }
        .reunion-date { font-size: 13px; color: #6b7280; margin-bottom: 4px; font-weight: 500; }
        .reunion-time { font-size: 13px; font-weight: 700; color: #16a34a; text-transform: capitalize;}
        
        .section-arrow { width: 20px; height: 20px; transition: transform 0.3s; fill: none; stroke: #16a34a; stroke-width: 2; margin-top: 2px; }
        .reunion-card.active-card .section-arrow { transform: rotate(180deg); stroke: #16a34a; }

        /* ESTILOS REUNIONES INTERNOS */
        .wol-style {
            font-family: 'Roboto', sans-serif;
            color: #212121;
            padding: 10px 20px 20px 20px !important; 
        }

        .sect-header { 
            font-size: 17px; font-weight: 900; margin: 28px 0 16px 0; 
            letter-spacing: 0.5px; text-transform: uppercase; 
            padding-left: 10px;
        }
        
        /* Gris oscuro para "SALA PRINCIPAL" y "SEGUNDA SALA" */
        .sect-subtitle {
            font-size: 13px; font-weight: 800; color: #374151; 
            text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 6px; padding-left: 10px;
        }
        
        .sr-conductor {
            font-size: 13px; color: #4b5563; padding-left: 10px; margin-bottom: 12px;
        }

        .c-tesoros { color: #2A6B77; }
        .c-maestros { color: #D38E22; }
        .c-vida { color: #9E1F1F; }
        .c-publico { color: #3B5E8F; }

        .header-roles { margin-bottom: 8px; padding-bottom: 0; padding-left: 10px; }
        .header-role-row { margin-bottom: 2px; font-size: 15px; color: #4b5563; line-height: 1.3; }
        .hr-label { font-weight: 800; color: #6b7280; margin-right: 6px; }

        /* Estructura Flexbox Fila de Reuni√≥n */
        .rt-row { display: flex; position: relative; padding-bottom: 18px; min-height: 40px; }
        .rt-time-col { display: none; }
        .rt-line-col { width: 20px; position: relative; flex-shrink: 0; display: flex; justify-content: center; margin-left: 4px;  }
        
        .timeline-group { position: relative; }
        .rt-line { position: absolute; width: 2px; background: #e5e7eb; left: 50%; transform: translateX(-50%); z-index: 0;  top: -10px; bottom: -10px;  }
        
        .timeline-group .rt-row:first-child .rt-line { top: 12px; } 
        .timeline-group .rt-row:last-child .rt-line { bottom: auto; height: 22px; top: -10px; } 
        .timeline-group .rt-row:first-child:last-child .rt-line { display: none; }

        .rt-dot { position: relative; z-index: 2; width: 10px; height: 10px; border-radius: 50%; margin-top: 7px; background: currentColor; box-shadow: 0 0 0 3px white, 0 0 0 5px currentColor; }
        .rt-dot::after { content: ''; position: absolute; top: -6px; left: -6px; right: -6px; bottom: -6px; border-radius: 50%; background: currentColor; opacity: 0.2; z-index: -1; }
        .rt-dot { border: 2px solid white; box-shadow: none; } 

        .rt-content-col { flex-grow: 1; padding-left: 12px; padding-top: 0; min-width: 0; }
        
        .rt-title { font-size: 16px; font-weight: 700; color: inherit; line-height: 1.35; margin-bottom: 4px; }
        .rt-time-tag { display: inline-block; color: #6b7280; font-weight: 500; margin-right: 6px; font-size: 15px; }
        .rt-who { font-size: 15px; color: #4b5563; line-height: 1.4; }
        
        .name-bullet-list { margin-top: 2px; }
        .name-bullet-item { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .name-bullet-dot { width: 5px; height: 5px; border-radius: 50%; background: currentColor; opacity: 0.7; flex-shrink: 0; }

        .sr-full-section { background-color: #f9fafb; padding: 16px 12px; margin-top: 10px; border-radius: 12px; border: 1px solid #e5e7eb; }
        .sr-full-section .rt-line-col { margin-left: 4px; }

        /* SECCI√ìN ASIGNACIONES Y RESPONSABILIDADES GLOBALES */
        .svc-container { margin-top: 16px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; }
        
        .svc-title-main { 
            font-size: 15px; font-weight: 900; margin-bottom: 16px; letter-spacing: 0.5px; 
            text-transform: uppercase; color: #6B7280; padding-left: 4px; 
        }

        .svc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .svc-block { margin-bottom: 4px; }
        
        .svc-block-title { font-size: 15px; font-weight: 700; color: #4B5563; margin-bottom: 4px; }
        .svc-bullet-item { display: flex; align-items: center; gap: 6px; font-size: 15px; font-weight: 400; color: #6b7280; margin-bottom: 2px; }
        .svc-bullet-dot { width: 5px; height: 5px; border-radius: 50%; background: #9ca3af; flex-shrink: 0; }
        
        .highlight-weekend-box {
            background-color: #ffffff; 
            border: 1px solid #e5e7eb; border-radius: 12px; margin-top: 32px; padding: 16px;
        }
        
        .hw-item { display: flex; flex-direction: row; justify-content: space-between; align-items: center; padding: 4px 0; width: 100%; }
        .hw-divider { height: 1px; background-color: #e5e7eb; width: 100%; margin: 8px 0; }
        
        .highlight-label { font-size: 14px; font-weight: 800; text-transform: uppercase; color: #6b7280; }
        .highlight-val { font-size: 15px; font-weight: 800; color: #16a34a; text-align: right; } 

        .highlight-midweek {
            background-color: #ffffff; 
            border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px;
            display: flex; justify-content: space-between; align-items: center; gap: 8px;
            margin-top: 32px; margin-bottom: 16px;
        }

        /* DIVISOR DE REUNIONES */
        .meeting-spacer { border-top: 2px solid #d1d5db; margin: 32px 16px; border-radius: 2px; }

        /* ANUNCIOS */
        .anuncio { background: #fffbeb; border-radius: 16px; padding: 16px; margin-bottom: 16px; display: flex; gap: 14px; align-items: flex-start; }
        .anuncio-date { background: #d97706; color: white; font-size: 11px; font-weight: 800; padding: 4px 8px; border-radius: 6px; white-space: nowrap; margin-top: 2px; }
        .anuncio-text { font-size: 14px; color: #4b5563; flex: 1; line-height: 1.5; }
        .footer { text-align: center; color: #9ca3af; font-size: 11px; margin-top: 40px; }
        .hidden { display: none !important; }
        
        /* CARGA INTEGRADA (INLINE SPINNER) */
        .inline-loader { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; color: #9ca3af; font-size: 13px; font-weight: 600; }
        .inline-loader .spinner { width: 26px; height: 26px; border: 3px solid #f3f4f6; border-top: 3px solid #6b7280; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #global-error { margin: 10px 20px 20px 20px; color: #ef4444; font-size: 13px; font-weight: 600; background: #fef2f2; padding: 12px; border-radius: 12px; text-align: center; }
    </style>
</head>
<body>

    <div class="nav-segment-container">
        <div class="nav-segment">
            <a href="#grupos-section" class="nav-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                Grupos
            </a>
            <a href="#reuniones-section" class="nav-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                Reuniones
            </a>
            <a href="#anuncios-section" class="nav-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" /></svg>
                Anuncios
            </a>
        </div>
    </div>

    <div class="container">
        
        <div id="global-error" class="hidden"></div>
        
        <h2 class="section-title-main" id="grupos-section">Grupos de Predicaci√≥n</h2>
        <div class="card">
            
            <div id="month-indicator" class="month-indicator">...</div>
            
            <div class="carousel-wrapper">
                <button id="btn-today" class="btn-today-floating" onclick="goToToday()">Ir a Hoy</button>
                <div class="carousel-arrow carousel-arrow-left" onclick="scrollCarousel(-1)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                </div>
                <div class="carousel-arrow carousel-arrow-right" onclick="scrollCarousel(1)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                </div>
                <div class="carousel" id="carousel"></div>
            </div>

            <div class="calendar-toggle-wrapper">
                <button class="calendar-toggle" onclick="toggleSection('calendario')">
                    <svg id="cal-toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span id="calendar-toggle-text">Mostrar calendario</span>
                </button>
            </div>
            
            <div class="section-content" id="calendario-content">
                <div class="section-inner"><div class="calendar-header"><div class="calendar-nav-btn" onclick="navMes(-1)">‚ùÆ</div><div class="calendar-month" id="calendar-month"></div><div class="calendar-nav-btn" onclick="navMes(1)">‚ùØ</div></div><div class="calendar-grid" id="calendario-grid"></div></div>
            </div>
            
            <div class="swipe-hint-box" id="aviso-grupos">
                <div class="swipe-hint-content">
                    <svg class="swipe-hint-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10.5 1.5C9.67 1.5 9 2.17 9 3v8.5l-1.63-1.63c-.4-.4-1.05-.4-1.42 0l-1.4 1.4c-.4.4-.4 1.05 0 1.42l5.65 5.65c.78.78 1.84 1.22 2.95 1.22h4.35c2.48 0 4.5-2.02 4.5-4.5V11.5c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v2h-1v-4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v1h-1v-4.5c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v1h-1V3c0-.83-.67-1.5-1.5-1.5z"/>
                    </svg>
                    <span class="swipe-hint-text">Desliza para cambiar de d√≠a</span>
                </div>
                <button class="swipe-hint-close" onclick="document.getElementById('aviso-grupos').style.display='none'">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>

            <div id="swipe-grupos-hoy" class="grupos-dia-container">
                <div id="grupos-dia-content">
                    <div class="inline-loader"><div class="spinner"></div><p>Cargando grupos...</p></div>
                </div>
            </div>

            <div class="ver-todos-wrapper">
                <button class="ver-todos-btn" id="ver-todos-btn" onclick="toggleSection('todos-grupos')">
                    <span id="ver-todos-text">Ver todos los grupos</span>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </button>
            </div>
            
            <div class="section-content" id="todos-grupos-content">
                <div class="section-inner">
                    <div id="swipe-timeline" class="timeline-wrapper"></div>
                    <div id="paginacion-container" class="pagination-container hidden"></div>
                </div>
            </div>
        </div>

        <h2 class="section-title-main" id="reuniones-section">Programa de Reuniones</h2>
        <div class="card" id="reuniones-swipe-wrapper">
            
            <div class="reunion-week-nav">
                <div class="week-nav-arrow" onclick="cambiarSemana(-1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></div>
                <div class="week-nav-text" onclick="resetearSemana()">Esta Semana</div>
                <div class="week-nav-arrow" onclick="cambiarSemana(1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></div>
            </div>

            <div class="swipe-hint-box" id="aviso-reuniones">
                <div class="swipe-hint-content">
                    <svg class="swipe-hint-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10.5 1.5C9.67 1.5 9 2.17 9 3v8.5l-1.63-1.63c-.4-.4-1.05-.4-1.42 0l-1.4 1.4c-.4.4-.4 1.05 0 1.42l5.65 5.65c.78.78 1.84 1.22 2.95 1.22h4.35c2.48 0 4.5-2.02 4.5-4.5V11.5c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v2h-1v-4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v1h-1v-4.5c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v1h-1V3c0-.83-.67-1.5-1.5-1.5z"/>
                    </svg>
                    <span class="swipe-hint-text">Desliza para cambiar de semana</span>
                </div>
                <button class="swipe-hint-close" onclick="document.getElementById('aviso-reuniones').style.display='none'">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>

            <div class="reunion-card" id="card-reunion-semana">
                <div class="reunion-header-click" onclick="toggleSection('reunion-semana')">
                    <div class="reunion-info">
                        <h3>Reuni√≥n Entre Semana <span class="reunion-badge hidden" id="badge-semana">HOY</span></h3>
                        <p class="reunion-date" id="fecha-semana"></p>
                        <p class="reunion-time" id="reunion-semana-time">Jueves 6:30 PM</p>
                    </div>
                    <svg class="section-arrow" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                </div>
                
                <div class="section-content" id="reunion-semana-content">
                    <div class="section-inner wol-style" id="reunion-semana-detalle">
                        <div class="inline-loader"><div class="spinner"></div><p>Cargando programa...</p></div>
                    </div>
                </div>
            </div>
            
            <div class="meeting-spacer"></div>

            <div class="reunion-card" id="card-reunion-finde">
                <div class="reunion-header-click" onclick="toggleSection('reunion-finde')">
                    <div class="reunion-info">
                        <h3>Reuni√≥n Fin de Semana <span class="reunion-badge hidden" id="badge-finde">HOY</span></h3>
                        <p class="reunion-date" id="fecha-finde"></p>
                        <p class="reunion-time" id="reunion-finde-time">Domingo 10:00 AM</p>
                    </div>
                    <svg class="section-arrow" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                </div>
                
                <div class="section-content" id="reunion-finde-content">
                    <div class="section-inner wol-style" id="reunion-finde-detalle">
                        <div class="inline-loader"><div class="spinner"></div><p>Cargando programa...</p></div>
                    </div>
                </div>
            </div>
        </div>

        <h2 class="section-title-main" id="anuncios-section">Anuncios</h2>
        <div class="card" style="padding: 20px;">
            <div id="anuncios-lista">
                <div class="inline-loader"><div class="spinner"></div><p>Cargando anuncios...</p></div>
            </div>
        </div>
        
        <div class="footer"><p>Actualizaci√≥n autom√°tica ‚Ä¢ Conectado</p><p id="data-stats"></p></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby3S6993gq473bX-STi42s-RLjsfr7MFHeZ5Eork8FCyEvepMLvRNqSQcjnM11xdwf_/exec"; 

        let dbGrupos = [], dbVidaMinisterio = [], dbFinSemana = [], dbAnuncios = [];
        let fechaHoy = new Date();
        let fechaSeleccionada = new Date(fechaHoy);
        let fechaVisualizadaCalendario = new Date(fechaHoy);
        let semanaOffset = 0;
        let sectionsExpanded = {};
        let paginaGruposActual = 1;
        const diasPorPagina = 3; 

        function toISODate(d) {
            if(!(d instanceof Date)) return "";
            return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        }

        async function iniciarApp() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Error HTTP: " + response.status);
                const dataRaw = await response.json();
                
                // --- TRADUCTOR DE GRUPOS PLANOS A AGRUPADOS POR FECHA ---
                const rawGrupos = dataRaw.grupos || [];
                let gruposAgrupados = {};
                
                rawGrupos.forEach(item => {
                    let f = item.Fecha || item.fecha || "";
                    f = f.substring(0, 10); 
                    if (!f) return;
                    
                    if (!gruposAgrupados[f]) {
                        gruposAgrupados[f] = { fecha: f, grupos: [] };
                    }
                    
                    gruposAgrupados[f].grupos.push({
                        hora: item.Hora || item.hora || "",
                        territorio: item.Territorio || item.territorio || "",
                        conductor: item.Conductor || item.conductor || "",
                        lugar: item.Lugar_Grupos || item.lugar_grupos || item.gruposassigned || "",
                        mapa: item.Mapa || item.mapa || ""
                    });
                });
                
                dbGrupos = Object.values(gruposAgrupados);
                dbGrupos.sort((a, b) => a.fecha.localeCompare(b.fecha));
                
                dbVidaMinisterio = dataRaw.vidaMinisterio || [];
                dbFinSemana = dataRaw.finSemana || [];
                dbAnuncios = dataRaw.anuncios || [];

                const total = dbGrupos.length + dbVidaMinisterio.length + dbFinSemana.length;
                document.getElementById('data-stats').textContent = `Registros: ${total}`;
                
                renderAll();
                setupSwipeGestures();
                setupMonthScrollListener();
                
                setTimeout(() => goToToday(), 100);

            } catch (error) {
                console.error(error);
                const errDiv = document.getElementById('global-error');
                errDiv.textContent = "Problema de conexi√≥n: " + error.message;
                errDiv.classList.remove('hidden');
                document.querySelectorAll('.inline-loader').forEach(el => el.innerHTML = '<p>Error al cargar la informaci√≥n.</p>');
            }
        }

        function setupMonthScrollListener() {
            const carousel = document.getElementById('carousel');
            const indicator = document.getElementById('month-indicator');
            
            carousel.addEventListener('scroll', () => {
                const cards = document.querySelectorAll('.date-card');
                const carouselRect = carousel.getBoundingClientRect();
                
                for (let card of cards) {
                    const cardRect = card.getBoundingClientRect();
                    if (cardRect.left >= carouselRect.left - 20 && cardRect.right <= carouselRect.right + 100) {
                        if(card.dataset.date) {
                            const d = new Date(card.dataset.date + "T00:00:00");
                            indicator.textContent = d.toLocaleDateString('es-ES', {month:'long', year:'numeric'});
                        } break;
                    }
                }
            });
        }
        function setupSwipeGestures() {
            setupSwipe('swipe-grupos-hoy', () => cambiarDiaSeleccionado(1), () => cambiarDiaSeleccionado(-1));
            setupSwipe('reuniones-swipe-wrapper', () => cambiarSemana(1), () => cambiarSemana(-1));
            setupSwipe('swipe-timeline', () => {
                const hoyStr = toISODate(fechaHoy);
                let listaFechas = dbGrupos.filter(g => g.fecha >= hoyStr);
                if(paginaGruposActual < Math.ceil(listaFechas.length/diasPorPagina)) { paginaGruposActual++; renderTodosGruposPaginados(); }
            }, () => { if(paginaGruposActual > 1) { paginaGruposActual--; renderTodosGruposPaginados(); } });
        }
        function setupSwipe(elementId, onSwipeLeft, onSwipeRight) {
            const element = document.getElementById(elementId);
            if (!element) return;
            let touchStartX = 0; let touchStartY = 0;
            element.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: true});
            element.addEventListener('touchend', e => {
                const diffX = touchStartX - e.changedTouches[0].screenX;
                const diffY = touchStartY - e.changedTouches[0].screenY;
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) { if (diffX > 0) onSwipeLeft(); else onSwipeRight(); }
            }, {passive: true});
        }
        function cambiarDiaSeleccionado(d) { 
            fechaSeleccionada.setDate(fechaSeleccionada.getDate() + d); 
            const fSel = toISODate(fechaSeleccionada);
            const fHoy = toISODate(fechaHoy);
            if (fSel < fHoy && !sectionsExpanded['calendario']) {
                toggleSection('calendario');
            }
            renderAll(); 
            const c = document.getElementById('carousel'); 
            const s = c.querySelector('.selected'); 
            if(s) s.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' }); 
        }
        function goToToday() { fechaSeleccionada = new Date(fechaHoy); semanaOffset = 0; renderAll(); const c = document.getElementById('carousel'); setTimeout(() => { const s = c.querySelector('.is-today'); if(s) s.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' }); }, 100); }
        function esMismoDia(f1, f2) { const str1 = f1 instanceof Date ? toISODate(f1) : f1; const str2 = f2 instanceof Date ? toISODate(f2) : f2; return str1 === str2; }

        function renderGruposDia() {
            const container = document.getElementById('grupos-dia-content');
            const fechaStr = toISODate(fechaSeleccionada);
            const data = dbGrupos.find(g => g.fecha === fechaStr);
            if (!data || !data.grupos || data.grupos.length === 0) { container.innerHTML = `<div class="no-grupos">No hay grupos programados para este d√≠a.</div>`; return; }
            let htmlInner = '';
            
            data.grupos.forEach(g => {
                const mapaHtml = g.mapa ? `<a href="${g.mapa}" target="_blank" style="text-decoration:none; color:#16a34a; font-size: 13px; font-weight:800; margin-left: 6px;">üìç Ver mapa</a>` : '';
                
                htmlInner += `
                <div class="grupo-item-hoy">
                    <div class="grupo-row-flex">
                        <div class="gh-hora-hoy">${g.hora}</div>
                        <div class="grupo-content-col">
                            <div class="gh-top-row">
                                <div class="gh-territorio">${g.territorio}</div>
                                <div class="gh-conductor">${g.conductor}</div>
                            </div>
                            ${g.lugar ? `<div class="gh-asignados">${g.lugar}${mapaHtml}</div>` : (mapaHtml ? `<div class="gh-asignados">${mapaHtml}</div>` : '')}
                        </div>
                    </div>
                </div>`;
            });
            const diaSemana = fechaSeleccionada.toLocaleDateString('es-ES', { weekday: 'long' });
            container.innerHTML = `<div class="grupo-consolidado-card"><div class="grupo-consolidado-header"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>Grupos del ${diaSemana}</div>${htmlInner}</div>`;
        }

        // =========================================================================
        //  RENDERIZADO REUNIONES
        // =========================================================================
        function renderReuniones() {
            const d = new Date(fechaHoy);
            const day = d.getDay(); 
            const diff = d.getDate() - day + (day == 0 ? -6 : 1) + (semanaOffset * 7);
            const lunes = new Date(d.setDate(diff));
            const lunesStr = toISODate(lunes);
            const domingo = new Date(lunes); domingo.setDate(lunes.getDate() + 6);
            const domingoStr = toISODate(domingo);
            const rangoTexto = `${lunes.getDate()} ${lunes.toLocaleDateString('es-ES',{month:'short'})} - ${domingo.getDate()} ${domingo.toLocaleDateString('es-ES',{month:'short'})}`;

            const buscar = (lista) => lista.find(r => r.fecha >= lunesStr && r.fecha <= domingoStr);
            const dataSemana = buscar(dbVidaMinisterio);
            const dataFinde = buscar(dbFinSemana);

            const containerSemana = document.getElementById('reunion-semana-detalle');
            const fechaSemanaEl = document.getElementById('fecha-semana');
            const badgeSemana = document.getElementById('badge-semana');
            const timeSemanaEl = document.getElementById('reunion-semana-time');

            // --- REUNI√ìN VIDA Y MINISTERIO ---
            if (dataSemana) {
                fechaSemanaEl.textContent = rangoTexto;
                
                const fPartsMid = dataSemana.fecha.split('-');
                const dMid = new Date(fPartsMid[0], fPartsMid[1]-1, fPartsMid[2]);
                const strMid = dMid.toLocaleDateString('es-ES', { weekday: 'long' });
                timeSemanaEl.textContent = `${strMid} 6:30 PM`;

                esMismoDia(dataSemana.fecha, fechaHoy) ? badgeSemana.classList.remove('hidden') : badgeSemana.classList.add('hidden');
                
                let html = `
                <div class="header-roles">
                    <div class="header-role-row">
                        <span class="hr-label">Presidente:</span> <strong>${dataSemana.presidente || "-"}</strong>
                    </div>
                    <div class="header-role-row">
                        <span class="hr-label">Oraci√≥n inicial:</span> <strong>${dataSemana.oracionInicial || "-"}</strong>
                    </div>
                </div>
                
                <div class="c-tesoros">
                    <div class="sect-header">TESOROS DE LA BIBLIA</div>
                    <div class="timeline-group">
                        ${renderFlexItem('Introducci√≥n', dataSemana.tesoros_introduccion_tiempo, formatBold(dataSemana.tesoros_introduccion_hermano), 'c-tesoros')}
                        ${renderFlexItem(dataSemana.tesoros_parte1_titulo, dataSemana.tesoros_parte1_tiempo, formatBold(dataSemana.tesoros_parte1_principal), 'c-tesoros')}
                        ${renderFlexItem(dataSemana.tesoros_parte2_titulo, dataSemana.tesoros_parte2_tiempo, formatBold(dataSemana.tesoros_parte2_principal), 'c-tesoros')}
                        
                        ${renderFlexItem('Lectura de la Biblia: ' + (dataSemana.tesoros_lectura_textos || ''), 
                                        dataSemana.tesoros_lectura_tiempo, 
                                        formatBold(dataSemana.tesoros_lectura_estudiante), 
                                        'c-tesoros')}
                    </div>
                        
                        ${dataSemana.tesoros_lectura_segundaSala ? `
                            <div class="sr-full-section">
                                <div class="sect-subtitle">SEGUNDA SALA</div>
                                <div class="sr-conductor">Conductor: <strong>${dataSemana.maestros_salaAuxiliar || '-'}</strong></div>
                                <div class="timeline-group">
                                    ${renderFlexItem('Lectura de la Biblia', '', formatBold(dataSemana.tesoros_lectura_segundaSala), 'c-tesoros')}
                                </div>
                            </div>
                        ` : ''}
                    
                </div>

                <div class="c-maestros">
                    <div class="sect-header">SEAMOS MEJORES MAESTROS</div>
                    <div class="sect-subtitle">SALA PRINCIPAL</div>
                    <div class="timeline-group">
                    `;
                    
                    let mainParts = [];
                    let secondParts = [];

                    for(let i=1; i<=5; i++) {
                        const titulo = dataSemana[`maestros_parte${i}_titulo`];
                        if(titulo) {
                            mainParts.push(renderFlexItem(
                                titulo, 
                                dataSemana[`maestros_parte${i}_tiempo`], 
                                formatHelper(dataSemana[`maestros_parte${i}_principal`], dataSemana[`maestros_parte${i}_ayudante`]), 
                                'c-maestros'
                            ));
                            
                            if(dataSemana[`maestros_parte${i}_segundaSala_principal`]) {
                                secondParts.push(renderFlexItem(
                                    titulo, 
                                    dataSemana[`maestros_parte${i}_tiempo`], 
                                    formatHelper(dataSemana[`maestros_parte${i}_segundaSala_principal`], dataSemana[`maestros_parte${i}_segundaSala_ayudante`]), 
                                    'c-maestros'
                                ));
                            }
                        }
                    }
                    
                    html += mainParts.join('');
                    html += `</div>`; 

                    if(secondParts.length > 0) {
                        html += `
                        <div class="sr-full-section">
                            <div class="sect-subtitle">SEGUNDA SALA</div>
                            <div class="sr-conductor">Conductor: <strong>${dataSemana.maestros_salaAuxiliar || '-'}</strong></div>
                            <div class="timeline-group">
                                ${secondParts.join('')}
                            </div>
                        </div>`;
                    }

                html += `</div>

                <div class="c-vida">
                    <div class="sect-header">NUESTRA VIDA CRISTIANA</div>
                    <div class="timeline-group">
                        ${renderFlexItem(dataSemana.vida_parte1_titulo, dataSemana.vida_parte1_tiempo, formatBold(dataSemana.vida_parte1_hermano), 'c-vida')}
                        ${renderFlexItem('Estudio b√≠blico', dataSemana.vida_estudioBiblico_tiempo, `Conductor: <strong>${dataSemana.vida_estudioBiblico_conductor}</strong><br>Lector: <strong>${dataSemana.vida_estudioBiblico_lector}</strong>`, 'c-vida')}
                        ${renderFlexItem('Palabras de conclusi√≥n', dataSemana.vida_conclusion_tiempo, formatBold(dataSemana.vida_conclusion_hermano), 'c-vida')}
                    </div>
                </div>
                
                <div style="margin-top: 4px; padding-top:4px; border-top:1px solid #f3f4f6; padding-left:10px;">
                    <div class="header-role-row">
                        <span class="hr-label">Oraci√≥n final:</span> <strong>${dataSemana.oracionFinal || "-"}</strong>
                    </div>
                </div>`;

                html += renderAssignmentsGrid(dataSemana, 'entreSemana');
                containerSemana.innerHTML = html;
            } else {
                fechaSemanaEl.textContent = rangoTexto + " (Sin datos)";
                badgeSemana.classList.add('hidden');
                containerSemana.innerHTML = `<div class="no-grupos">Sin programaci√≥n cargada para esta semana.</div>`;
            }

            const containerFinde = document.getElementById('reunion-finde-detalle');
            const fechaFindeEl = document.getElementById('fecha-finde');
            const badgeFinde = document.getElementById('badge-finde');
            const timeFindeEl = document.getElementById('reunion-finde-time');

            // --- REUNI√ìN FIN DE SEMANA ---
            if (dataFinde) {
                const fParts = dataFinde.fecha.split('-');
                const fDate = new Date(fParts[0], fParts[1]-1, fParts[2]);
                fechaFindeEl.textContent = fDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
                
                const strWk = fDate.toLocaleDateString('es-ES', { weekday: 'long' });
                timeFindeEl.textContent = `${strWk} 10:00 AM`;

                esMismoDia(dataFinde.fecha, fechaHoy) ? badgeFinde.classList.remove('hidden') : badgeFinde.classList.add('hidden');
                
                let html = `
                <div class="header-roles">
                    <div class="header-role-row">
                        <span class="hr-label">Presidente:</span> <strong>${dataFinde.presidente || "-"}</strong>
                    </div>
                    <div class="header-role-row">
                        <span class="hr-label">Oraci√≥n inicial:</span> <strong>${dataFinde.oracionInicial || "-"}</strong>
                    </div>
                </div>
                
                <div class="c-publico">
                    <div class="sect-header">DISCURSO P√öBLICO</div>
                    <div class="timeline-group">
                        ${renderFlexItem(`"${dataFinde.discursoPublico_tema}"`, '', `<strong>${dataFinde.discursoPublico_orador}</strong><br><span style="font-size:14px; color:#6b7280;">${dataFinde.discursoPublico_congregacion}</span>`, 'c-publico')}
                    </div>
                </div>
                
                <div class="c-publico">
                    <div class="sect-header">ESTUDIO DE LA ATALAYA</div>
                    <div class="timeline-group">
                        ${renderFlexItem(dataFinde.estudioAtalaya_articulo, '', `Conductor: <strong>${dataFinde.estudioAtalaya_conductor}</strong><br>Lector: <strong>${dataFinde.estudioAtalaya_lector}</strong>`, 'c-publico')}
                    </div>
                </div>
                
                <div style="margin-top: 4px; padding-top:4px; border-top:1px solid #f3f4f6; padding-left:10px;">
                    <div class="header-role-row">
                        <span class="hr-label">Oraci√≥n final:</span> <strong>${dataFinde.oracionFinal || "-"}</strong>
                    </div>
                </div>`;
                
                html += renderAssignmentsGrid(dataFinde, 'finSemana');
                containerFinde.innerHTML = html;
            } else {
                fechaFindeEl.textContent = "Sin datos";
                badgeFinde.classList.add('hidden');
                containerFinde.innerHTML = `<div class="no-grupos">Sin programaci√≥n para este fin de semana.</div>`;
            }
        }

        // --- RENDER FLEX ITEM ---
        function renderFlexItem(title, time, who, parentClass) {
            if(!title) return '';
            
            let timeSpan = time ? `<span class="rt-time-tag">${time}</span>` : '';
            let contentHTML = `<div class="rt-title">${timeSpan}${title}</div>`;
            
            if (who) {
                contentHTML += `<div class="rt-who">${who}</div>`;
            }

            return `
            <div class="rt-row ${parentClass}">
                <div class="rt-time-col"></div> 
                <div class="rt-line-col">
                    <div class="rt-line"></div>
                    <div class="rt-dot"></div>
                </div>
                <div class="rt-content-col">
                    ${contentHTML}
                </div>
            </div>`;
        }

        function formatHelper(principal, ayudante) {
            if (!principal) return '';
            if (ayudante) {
                return `
                <div class="name-bullet-list">
                    <div class="name-bullet-item"><div class="name-bullet-dot"></div><strong>${principal}</strong></div>
                    <div class="name-bullet-item"><div class="name-bullet-dot"></div><span style="color:#6b7280; font-weight:700;">${ayudante}</span> (Ayudante)</div>
                </div>`;
            }
            return `<strong>${principal}</strong>`;
        }

        function formatBold(text) {
            return text ? `<strong>${text}</strong>` : '';
        }

        // --- ASIGNACIONES / SERVICIOS ---
        function renderAssignmentsGrid(data, type) {
            let list = '';
            let highlights = '';

            if (type === 'entreSemana') {
                if(data.limpiezaSuperficial) {
                     highlights += `
                    <div class="highlight-midweek">
                        <span class="highlight-label">Limpieza Superficial</span>
                        <span class="highlight-val">Grupo ${data.limpiezaSuperficial}</span>
                    </div>`;
                }
                
                let gridItems = '';
                const addGridItem = (label, value) => {
                    if(!value) return '';
                    let names = value.split(/,| y | Y /).map(n => n.trim()).filter(n => n);
                    let namesHtml = '';
                    names.forEach(n => {
                        namesHtml += `<div class="svc-bullet-item"><div class="svc-bullet-dot"></div>${n}</div>`;
                    });
                    return `<div class="svc-block"><div class="svc-block-title">${label}</div>${namesHtml}</div>`;
                };

                gridItems += addGridItem('Encargado', data.encargado);
                gridItems += addGridItem('Auditorio', `${data.acomodadorAuditorio1}, ${data.acomodadorAuditorio2}`);
                gridItems += addGridItem('Puerta', data.acomodadorPuerta);
                gridItems += addGridItem('Micr√≥fonos', `${data.microfonos1}, ${data.microfonos2}`);
                gridItems += addGridItem('Audio/Video', `${data.audioVideo1}, ${data.audioVideo2}`);
                gridItems += addGridItem('Plataforma', data.plataforma);
                
                list = `<div class="svc-grid" style="margin-top:16px;">${gridItems}</div>`;
            }
            
            if (type === 'finSemana') {
                if(data.limpiezaAFondo || data.hospitalidad) {
                    highlights += `<div class="highlight-weekend-box">`;
                    
                    if(data.limpiezaAFondo) {
                         highlights += `
                            <div class="hw-item">
                                <span class="highlight-label">Limpieza Profunda</span>
                                <span class="highlight-val">Grupo ${data.limpiezaAFondo}</span>
                            </div>
                        `;
                    }
                    
                    if(data.limpiezaAFondo && data.hospitalidad) {
                        highlights += `<div class="hw-divider"></div>`;
                    }
                    
                    if(data.hospitalidad) {
                         highlights += `
                            <div class="hw-item">
                                <span class="highlight-label">Hospitalidad</span>
                                <span class="highlight-val">Grupo ${data.hospitalidad}</span>
                            </div>
                        `;
                    }
                    highlights += `</div>`;
                }

                let gridItems = '';
                const addGridItem = (label, value) => {
                    if(!value) return '';
                    let names = value.split(/,| y | Y /).map(n => n.trim()).filter(n => n);
                    let namesHtml = '';
                    names.forEach(n => {
                        namesHtml += `<div class="svc-bullet-item"><div class="svc-bullet-dot"></div>${n}</div>`;
                    });
                    return `<div class="svc-block"><div class="svc-block-title">${label}</div>${namesHtml}</div>`;
                };
                
                gridItems += addGridItem('Encargado', data.encargado);
                gridItems += addGridItem('Auditorio', `${data.acomodadorAuditorio1}, ${data.acomodadorAuditorio2}`);
                gridItems += addGridItem('Puerta', data.acomodadorPuerta);
                gridItems += addGridItem('Micr√≥fonos', `${data.microfonos1}, ${data.microfonos2}`);
                gridItems += addGridItem('Audio/Video', `${data.audioVideo1}, ${data.audioVideo2}`);
                gridItems += addGridItem('Plataforma', data.plataforma);
                
                list = `<div class="svc-grid">${gridItems}</div>`;
            }

            if(!list && !highlights) return '';

            return `
            ${highlights}
            <div class="svc-container">
                <div class="svc-title-main">ASIGNACIONES</div>
                ${list}
            </div>`;
        }

        function renderAnuncios() {
            const limpiar = (f) => {
                if(!f) return "";
                if(f.includes('-')) {
                    const parts = f.split('-');
                    const d = new Date(parts[0], parts[1]-1, parts[2]);
                    const mes = d.toLocaleDateString('es-ES', { month: 'short' }).toUpperCase().replace('.', '');
                    return `${d.getDate()} ${mes}`;
                } return f;
            };
            const html = dbAnuncios.map(a => `<div class="anuncio"><div class="anuncio-date">${limpiar(a.fechaInicio)} ${a.fechaFin ? '- ' + limpiar(a.fechaFin) : ''}</div><div class="anuncio-text">${a.texto}</div></div>`).join('');
            document.getElementById('anuncios-lista').innerHTML = html || '<div class="no-grupos">No hay anuncios recientes.</div>';
        }

        function renderAll() {
            const d = new Date(fechaSeleccionada.getTime());
            document.getElementById('month-indicator').textContent = d.toLocaleDateString('es-ES', {month:'long', year:'numeric'});
            const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
            const mon = new Date(d.setDate(diff)); const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
            
            const btnToday = document.getElementById('btn-today');
            if (!esMismoDia(fechaSeleccionada, fechaHoy)) {
                btnToday.style.display = 'flex'; 
            } else {
                btnToday.style.display = 'none';
            }
            
            renderCalendarGrid(); renderCarousel(); renderGruposDia(); renderReuniones(); renderTodosGruposPaginados(); renderAnuncios();
        }

        function formatearFecha(fInput) { if(!fInput) return ""; const parts = fInput.split('-'); const d = new Date(parts[0], parts[1]-1, parts[2]); return d.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); }
        
        function renderCalendarGrid() { 
            document.getElementById('calendar-month').textContent = fechaVisualizadaCalendario.toLocaleDateString('es-ES', {month:'long', year:'numeric'}); 
            const grid = document.getElementById('calendario-grid'); 
            grid.innerHTML=''; 
            ['D','L','M','M','J','V','S'].forEach(d=>grid.innerHTML+=`<div class="calendar-day-header">${d}</div>`); 
            const first = new Date(fechaVisualizadaCalendario.getFullYear(), fechaVisualizadaCalendario.getMonth(), 1); 
            const days = new Date(fechaVisualizadaCalendario.getFullYear(), fechaVisualizadaCalendario.getMonth()+1, 0).getDate(); 
            for(let i=0; i<first.getDay(); i++) grid.innerHTML+=`<div></div>`; 
            for(let i=1; i<=days; i++) { 
                let d = document.createElement('div'); 
                d.className='calendar-day'; 
                d.textContent=i; 
                const fStr = `${fechaVisualizadaCalendario.getFullYear()}-${String(fechaVisualizadaCalendario.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; 
                if(fStr === toISODate(fechaSeleccionada)) d.classList.add('selected'); 
                if(fStr === toISODate(fechaHoy)) d.classList.add('today'); 
                d.onclick=()=>{ 
                    fechaVisualizadaCalendario.setMonth(fechaVisualizadaCalendario.getMonth()); 
                    fechaSeleccionada = new Date(fechaVisualizadaCalendario.getFullYear(), fechaVisualizadaCalendario.getMonth(), i); 
                    if (sectionsExpanded['calendario']) { toggleSection('calendario'); }
                    renderAll(); 
                }; 
                grid.appendChild(d); 
            } 
        }

        function renderCarousel() { const c = document.getElementById('carousel'); c.innerHTML = ''; const b = new Date(fechaHoy); let startBase = b; if (fechaSeleccionada > new Date(b.getTime() + (60*86400000)) || fechaSeleccionada < new Date(b.getTime() - (10*86400000))) { startBase = new Date(fechaSeleccionada); } for(let i=-2; i<=60; i++) { const f = new Date(startBase); f.setDate(startBase.getDate() + i); const card = document.createElement('div'); card.dataset.date = toISODate(f); card.className = `date-card ${esMismoDia(f, fechaSeleccionada) ? 'selected' : ''} ${esMismoDia(f, fechaHoy) ? 'is-today' : ''}`; card.innerHTML = `<div class="date-card-day">${f.toLocaleDateString('es-ES',{weekday:'short'}).slice(0,3)}</div><div class="date-card-number">${f.getDate()}</div>`; card.onclick = () => { fechaSeleccionada = f; renderAll(); }; c.appendChild(card); } }
        
        function renderTodosGruposPaginados() { const tl = document.getElementById('swipe-timeline'); const pagContainer = document.getElementById('paginacion-container'); tl.innerHTML = ''; pagContainer.innerHTML = ''; const hoyStr = toISODate(fechaHoy); let listaFechas = dbGrupos.filter(g => g.fecha >= hoyStr); listaFechas.sort((a, b) => new Date(a.fecha) - new Date(b.fecha)); if (listaFechas.length === 0) { tl.innerHTML = '<div class="no-grupos">No hay grupos futuros programados.</div>'; pagContainer.classList.add('hidden'); return; } const totalPaginas = Math.ceil(listaFechas.length / diasPorPagina); if (paginaGruposActual > totalPaginas) paginaGruposActual = 1; const inicio = (paginaGruposActual - 1) * diasPorPagina; const fechasPagina = listaFechas.slice(inicio, inicio + diasPorPagina); fechasPagina.forEach(diaData => { const fechaNice = formatearFecha(diaData.fecha); const dayBlock = document.createElement('div'); dayBlock.className = 'timeline-day-block'; if (esMismoDia(diaData.fecha, fechaSeleccionada)) dayBlock.classList.add('active-day'); const header = document.createElement('div'); header.className = 'timeline-date-header'; header.textContent = fechaNice; dayBlock.appendChild(header); diaData.grupos.forEach(g => { 
            
            const mapaHtml = g.mapa ? `<a href="${g.mapa}" target="_blank" style="text-decoration:none; color:#16a34a; font-size: 13px; font-weight:800; margin-left: 6px;">üìç Ver mapa</a>` : '';
            
            const row = document.createElement('div'); row.className = 'timeline-row'; row.innerHTML = `<div class="grupo-row-flex"><div class="gh-hora-timeline">${g.hora}</div><div class="grupo-content-col"><div class="gh-top-row"><div class="gh-territorio">${g.territorio}</div><div class="gh-conductor">${g.conductor}</div></div>${g.lugar ? `<div class="gh-asignados">${g.lugar}${mapaHtml}</div>` : (mapaHtml ? `<div class="gh-asignados">${mapaHtml}</div>` : '')}</div></div>`; dayBlock.appendChild(row); }); tl.appendChild(dayBlock); }); if (totalPaginas > 1) { pagContainer.classList.remove('hidden'); const btnPrev = document.createElement('button'); btnPrev.className = 'page-btn'; btnPrev.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>'; btnPrev.disabled = paginaGruposActual === 1; btnPrev.onclick = () => { paginaGruposActual--; renderTodosGruposPaginados(); }; pagContainer.appendChild(btnPrev); for (let i = 1; i <= totalPaginas; i++) { const btn = document.createElement('button'); btn.className = `page-btn ${i === paginaGruposActual ? 'active' : ''}`; btn.textContent = i; btn.onclick = () => { paginaGruposActual = i; renderTodosGruposPaginados(); }; pagContainer.appendChild(btn); } const btnNext = document.createElement('button'); btnNext.className = 'page-btn'; btnNext.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>'; btnNext.disabled = paginaGruposActual === totalPaginas; btnNext.onclick = () => { paginaGruposActual++; renderTodosGruposPaginados(); }; pagContainer.appendChild(btnNext); } else { pagContainer.classList.add('hidden'); } }
        
        function toggleSection(id) { 
            const c = document.getElementById(id + '-content'); 
            const card = document.getElementById('card-' + id); 
            sectionsExpanded[id] = !sectionsExpanded[id]; 
            c.classList.toggle('expanded'); 
            if (card) card.classList.toggle('active-card'); 
            
            if(id === 'todos-grupos') { 
                const btnText = document.getElementById('ver-todos-text'); 
                const btn = document.getElementById('ver-todos-btn'); 
                if (sectionsExpanded[id]) { 
                    btnText.textContent = "Ocultar grupos"; 
                    btn.classList.add('expanded'); 
                    paginaGruposActual = 1; 
                    renderTodosGruposPaginados(); 
                } else { 
                    btnText.textContent = "Ver todos los grupos"; 
                    btn.classList.remove('expanded'); 
                } 
            } 
            
            if(id === 'calendario') { 
                const calText = document.getElementById('calendar-toggle-text'); 
                const calIcon = document.getElementById('cal-toggle-icon');
                if (sectionsExpanded[id]) { 
                    calText.textContent = "Ocultar calendario"; 
                    // Flecha arriba desvaneci√©ndose
                    calIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" stroke-width="2"/>`;
                    calIcon.classList.add('fade-up-anim');
                } else { 
                    calText.textContent = "Mostrar calendario"; 
                    // Icono de calendario normal
                    calIcon.innerHTML = `<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>`;
                    calIcon.classList.remove('fade-up-anim');
                } 
            } 
        }
        
        function scrollCarousel(d) { document.getElementById('carousel').scrollBy({ left: d * 120, behavior: 'smooth' }); }
        function cambiarSemana(d) { semanaOffset += d; renderReuniones(); }
        function resetearSemana() { semanaOffset = 0; renderReuniones(); }
        function navMes(d) { fechaVisualizadaCalendario.setMonth(fechaVisualizadaCalendario.getMonth() + d); renderCalendarGrid(); }

        iniciarApp();
    </script>
</body>
</html>

